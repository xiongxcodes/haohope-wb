{"hidden":false,"children":[{"configs":{"itemId":"module","serverScript":"var disableUpdateTitle = !app.perm('m?xwl=dev/otherinfo/community/update-title'),\n  disableDeleteTitle = !app.perm('m?xwl=dev/otherinfo/community/delete-title'),\n  disableSetTop = !app.perm('m?xwl=dev/otherinfo/community/set-top');\n\napp.set({\n  disableUpdateTitle: disableUpdateTitle,\n  disableDeleteTitle: disableDeleteTitle,\n  disableSetTop: disableSetTop,\n  hideActionCol: disableUpdateTitle && disableDeleteTitle && disableSetTop\n});","jsLinks":"[\"wb/libs/cm/cmirror{#debugSuffix#}.js\"]","cssLinks":"[\"wb/libs/cm/cmirror{#debugSuffix#}.css\",\"wb/css/bbs{#debugSuffix#}.css\"]"},"expanded":true,"children":[{"configs":{"layout":"border","itemId":"editWin","focusControl":"TITLE","editWin":"true","resizable":"true","width":"900","iconCls":"list_icon","height":"450","maximizable":"true"},"expanded":false,"children":[{"configs":{"itemId":"TITLE","allowBlank":"false","margin":"0 0 8 0","emptyText":"标题","region":"north","maxLength":"200"},"expanded":false,"children":[],"type":"text"},{"configs":{"itemId":"CONTENT","region":"center"},"expanded":false,"children":[],"type":"htmleditor","events":{"afterrender":"app.addToolButtons();"}},{"configs":{"itemId":"fileForm","hidden":"true"},"expanded":true,"children":[{"configs":{"itemId":"file1"},"expanded":false,"children":[],"type":"file","events":{"change":"if (newValue) {\n  Wb.upload({\n    form: app.fileForm,\n    showProgress: true,\n    url: 'm?xwl=dev/otherinfo/community/upload-file',\n    success: function(form, action, value) {\n      app.CONTENT.focusOn(function() {\n        app.CONTENT.insertAtCursor(value);\n        Wb.reset(form);\n      });\n    }\n  });\n}"}}],"type":"form"}],"type":"window","events":{"ok":"var values = Wb.getValue(win);\nswitch (app.operationType) {\n  case 'insertTitle':\n    Wb.request({\n      url: 'm?xwl=dev/otherinfo/community/insert-title',\n      params: values,\n      success: function(resp) {\n        var index = 0;\n        app.titleStore.each(function(rec) {\n          if (rec.data.SET_TOP === 0) {\n            return false;\n          }\n          index++;\n        });\n        Wb.add(app.grid1, Wb.apply(values, Wb.decode(resp.responseText)), index);\n        win.close();\n      }\n    });\n    break;\n  case 'updateTitle':\n    values = Wb.applyIf(values, Wb.getData(app.currentRec, true));\n    Wb.request({\n      url: 'm?xwl=dev/otherinfo/community/update-title',\n      params: values,\n      success: function(resp) {\n        Wb.update(app.currentRec, Wb.apply(values, Wb.decode(resp.responseText)));\n        win.close();\n        Wb.highlight(app.currentRec);\n      }\n    });\n    break;\n  case 'replyTitle':\n    var card = app.tab1.getActiveTab();\n    values.TITLE_ID = card.titleId;\n    Wb.request({\n      url: 'm?xwl=dev/otherinfo/community/insert-post',\n      params: values,\n      success: function(resp) {\n        var div = card.el.down('[class=bbs-center-div]');\n\n        div.insertHtml('beforeEnd', resp.responseText);\n        Wb.highlightCode(card);\n        win.close();\n        Wb.toBottom(card);\n      }\n    });\n    break;\n  case 'editPost':\n    values.POST_ID = app.currentPostId;\n    Wb.request({\n      url: 'm?xwl=dev/otherinfo/community/update-post',\n      params: values,\n      success: function() {\n        app.currentDetailCell.update(values.CONTENT);\n        win.close();\n      }\n    });\n    break;\n}"}},{"configs":{"itemId":"postToolBar","createInstance":"false"},"expanded":true,"children":[{"configs":{"itemId":"replyBtn","tooltip":"回复当前主题","text":"回复","iconCls":"start_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.operationType = 'replyTitle';\napp.editWin.show();\napp.TITLE.hide();\napp.editWin.setTitle('回复主题');\napp.CONTENT.focusOn();"}},{"configs":{"itemId":"refreshBtn","tooltip":"刷新当前的主题内容","text":"刷新","iconCls":"refresh_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"var card = app.tab1.getActiveTab();\nWb.request({\n  url: 'm?xwl=dev/otherinfo/community/select-post',\n  params: {\n    id: card.titleId\n  },\n  success: function(resp) {\n    card.update(resp.responseText);\n    Wb.highlightCode(card);\n  }\n});"}},{"configs":{"itemId":"item1","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"toBottomBtn","tooltip":"滚动到页面底部","text":"底部","iconCls":"bottom_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.toBottom(app.tab1.getActiveTab());"}},{"configs":{"itemId":"backBtn","tooltip":"返回到主题列表","text":"返回","iconCls":"db_form_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.tab1.setActiveTab(app.panel1);"}},{"configs":{"itemId":"urlText","flex":"1","readOnly":"true","selectOnFocus":"true"},"expanded":false,"children":[],"type":"text"}],"type":"toolbar"},{"configs":{"layout":"fit","itemId":"viewport1"},"expanded":true,"children":[{"configs":{"itemId":"tab1","plugins":"['tabreorderer', 'tabclosemenu']"},"expanded":true,"children":[{"configs":{"layout":"fit","itemId":"panel1","title":"主题列表","iconCls":"db_form_icon"},"expanded":true,"children":[{"configs":{"isConfig":"true","itemId":"tbar","normalName":"titleBar"},"expanded":false,"children":[{"configs":{"itemId":"newBtn","bindModule":"m?xwl=dev/otherinfo/community/insert-title","tooltip":"发表新的主题","text":"发表主题","iconCls":"record_add_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.operationType = 'insertTitle';\napp.editWin.show();\napp.TITLE.show();\napp.editWin.setTitle('发表新的主题');"}},{"configs":{"itemId":"item1","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"searchCombo","onTriggerClick":"app.searchText = this.getValue();\nthis.collapse();\napp.loadData();","emptyText":"标题","triggerCls":"x-form-search-trigger","width":"280","displayField":"TITLE","enterKeyTriggerClick":"true"},"expanded":false,"children":[{"configs":{"itemId":"store","url":"m?xwl=dev/otherinfo/community/search-title"},"expanded":false,"children":[],"type":"store"}],"type":"combo","events":{"select":"combo.onTriggerClick();"}},{"configs":{"itemId":"resetSearchBtn","tooltip":"重置搜索结果","text":"重置搜索","iconCls":"undo_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.searchText = null;\napp.loadData();"}},{"configs":{"itemId":"item2","text":"->"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"allItemsBtn","handler":"app.loadData","pressed":"true","allowDepress":"false","toggleGroup":"range","text":"全部主题"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"postItemsBtn","handler":"app.loadData","allowDepress":"false","toggleGroup":"range","text":"我发表的"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"replyItemsBtn","handler":"app.loadData","allowDepress":"false","toggleGroup":"range","text":"我回复的"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"item3","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"toggleuser","bindModule":"m?xwl=dev/otherinfo/community/insert-title","tooltip":"使用另一个用户帐户登录","text":"切换用户","iconCls":"user_add_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.confirm('确定要退出当前登录并使用新帐户重新登录吗？', function() {\n  Wb.request({\n    url: 'logout',\n    success: function(resp) {\n      window.location.replace('community');\n    }\n  });\n});"}}],"type":"toolbar"},{"configs":{"itemId":"grid1","autoRowNumWidth":"true","viewConfig":"{\n  getRowClass: function(r) {\n    if (r.data.SET_TOP) return 'bbs-top-row';\n    else return '';\n  }\n}","cls":"bbs-title-grid"},"expanded":false,"children":[{"configs":{"itemId":"columns"},"expanded":true,"children":[{"configs":{"itemId":"numCol","xtype":"rownumberer"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"titleCol","renderer":"value = Wb.encodeHtml(value);\nif (record.data.SET_TOP)\n  value = '<b>' + value + '<\/b>';\nreturn value;","dataIndex":"TITLE","flex":"1","text":"标题","autoWrap":"true"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"createCol","renderer":"return record.data.CREATE_DISP_USER + '<br>' + Wb.dateToText(value);","dataIndex":"CREATE_DATE","width":"150","text":"首次创建","align":"center"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"countCol","renderer":"return Wb.format(value, '0,000') + ' / ' + Wb.format(record.data.VIEW_COUNT, '0,000');","dataIndex":"REPLY_COUNT","width":"100","text":"回复次数","align":"center"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"replyCol","renderer":"return record.data.REPLY_DISP_USER + '<br>' + Wb.dateToText(value);","dataIndex":"MODIFY_DATE","width":"150","text":"最后回复","align":"center"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"actionCols","xtype":"actioncolumn","hidden":"{#hideActionCol#}","width":"70","text":"操作","align":"center"},"expanded":true,"children":[{"configs":{"itemId":"items"},"expanded":true,"children":[{"configs":{"itemId":"editAction","handler":"app.currentRec = record;\nWb.request({\n  url: 'm?xwl=dev/otherinfo/community/get-title-content',\n  params: record.data,\n  success: function(resp) {\n    app.operationType = 'updateTitle';\n    app.editWin.show();\n    app.TITLE.show();\n    app.editWin.setTitle('修改主题');\n    Wb.setValue(app.editWin, Wb.apply(Wb.decode(resp.responseText), record.data));\n  }\n});","tooltip":"修改","disabled":"{#disableUpdateTitle#}","iconCls":"record_edit_icon"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"deleteAction","handler":"Wb.confirm('确定要删除该主题吗？', function() {\n  Wb.request({\n    url: 'm?xwl=dev/otherinfo/community/delete-title',\n    params: {\n      destroy: Wb.getData([record], true)\n    },\n    success: function() {\n      Wb.remove(app.grid1, record);\n    }\n  });\n});","tooltip":"删除","disabled":"{#disableDeleteTitle#}","iconCls":"record_delete_icon"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"setTopAction","handler":"Wb.prompt({\n  title: '置顶',\n  iconCls: 'top_icon',\n  items: [{\n    fieldLabel: '权重',\n    allowBlank: false,\n    itemId: 'weight',\n    xtype: 'numberfield',\n    minValue: 0,\n    value: record.data.SET_TOP || 5, //如果权重为0则设置为5\n    maxValue: 9\n  }],\n  handler: function(values, win) {\n    Wb.request({\n      url: 'm?xwl=dev/otherinfo/community/set-top',\n      params: Wb.apply(values, record.data),\n      success: function(resp) {\n        win.close();\n        record.store.reload();\n      }\n    });\n  }\n});","tooltip":"置顶","disabled":"{#disableSetTop#}","iconCls":"top_icon"},"expanded":false,"children":[],"type":"column"}],"type":"array"}],"type":"column"}],"type":"array"},{"configs":{"itemId":"store","normalName":"titleStore","autoLoad":"true","url":"m?xwl=dev/otherinfo/community/select-title"},"expanded":false,"children":[],"type":"store"}],"type":"grid","events":{"itemclick":"var titleId = record.data.TITLE_ID,\n  card = app.tab1.child('[titleId=' + titleId + ']');\nif (card) {\n  app.tab1.setActiveTab(card);\n} else {\n  Wb.request({\n    url: 'm?xwl=dev/otherinfo/community/select-post',\n    params: {\n      id: titleId\n    },\n    success: function(resp) {\n      delete app._postToolBar.itemId;\n      var card = app.tab1.add({\n        tbar: app._postToolBar,\n        xtype: 'panel',\n        titleId: titleId,\n        bodyStyle: 'background:#f5f5f5',\n        autoScroll: true,\n        html: resp.responseText,\n        title: Ext.String.ellipsis(record.data.TITLE, 20),\n        tabConfig: {\n          tooltip: record.data.TITLE\n        },\n        iconCls: 'script_icon',\n        closable: true\n      });\n      app.urlText.setValue(Wb.getRelPath() + '/show-title?id=' + titleId);\n      app.tab1.setActiveTab(card);\n      Wb.highlightCode(card);\n    }\n  });\n}"}}],"type":"panel"}],"type":"tab","events":{"afterrender":"tab.mon(tab.el, 'click', app.tabClickHandler);"}}],"type":"viewport","events":{"afterrender":"viewport.mon(viewport.el, 'click', function(e) {\n  var src = e.target.src;\n  if (e.target.tagName == 'IMG' && e.target.src && app.tab1.el.isAncestor(e.target) && !app.panel1.el.isAncestor(e.target)) {\n    Wb.run({\n      url: 'image-viewer',\n      single: true,\n      success: function() {\n        this.show(src);\n        e.stopEvent();\n      }\n    });\n  }\n});"}}],"type":"module","events":{"initialize":"Wb.apply(app, {\n  //加载数据\n  loadData: function() {\n    app.titleStore.load({\n      params: {\n        searchTitle: app.searchText,\n        searchRange: Wb.getPressed(app.titleBar, 'range').itemId.slice(0, -3)\n      }\n    });\n  },\n  //插入文件\n  insertFile: function() {\n    app.file1.fileInputEl.dom.click();\n  },\n  //插入脚本\n  insertScript: function(me, item) {\n    var type = item.text;\n    Wb.run({\n      url: 'script-win',\n      single: type + '-script-win',\n      success: function(scope) {\n        scope.show(function(script, win) {\n          if (!script) {\n            Wb.warn('脚本不能为空。', scope.focusEditor);\n            return;\n          }\n          win.close();\n          app.CONTENT.focusOn(function() {\n            app.CONTENT.insertAtCursor('<textarea style=\"width:95%\" rows=\"10\" class=\"' + item.text + '_class\" readonly=\"readonly\">' + Ext.htmlEncode(script) + '<\/textarea><br>');\n          });\n        }, {\n          type: type,\n          title: '插入 - ' + type,\n          iconCls: item.iconCls\n        });\n      }\n    });\n  },\n  addToolButtons: function() {\n    var editor = app.CONTENT;\n    editor.toolbar.insert(17, [{\n      tooltip: '插入文件或图片',\n      iconCls: 'open_icon',\n      handler: app.insertFile\n    }, {\n      tooltip: '插入代码片断',\n      iconCls: 'script_icon',\n      menu: {\n        xtype: 'menu',\n        listeners: {\n          click: app.insertScript\n        },\n        items: [{\n          iconCls: 'file_java_icon',\n          text: 'java'\n        }, {\n          iconCls: 'js_icon',\n          text: 'js'\n        }, {\n          iconCls: 'file_css_icon',\n          text: 'css'\n        }, {\n          iconCls: 'web_icon',\n          text: 'html'\n        }, {\n          iconCls: 'sql_icon',\n          text: 'sql'\n        }, {\n          iconCls: 'file_xml_icon',\n          text: 'xml'\n        }, {\n          iconCls: 'file_jsp_icon',\n          text: 'jsp'\n        }, {\n          iconCls: 'file_txt_icon',\n          text: 'others'\n        }]\n      }\n    }]);\n  },\n  //tab控件的点击事件句柄\n  tabClickHandler: function(e, target) {\n    var el, xitemId = Ext.fly(target).getAttribute('xitemId');\n    if (xitemId) {\n      el = Ext.get(target);\n      app.currentPost = el.up('[class=bbs-post-table]');\n      if (app.currentPost) {\n        app.currentPostId = app.currentPost.getAttribute('postId');\n        app.currentDetailCell = app.currentPost.down('[class=bbs-post-detail]');\n      }\n      if (app.currentPostId) {\n        if (xitemId == 'editPost')\n          app.editPost();\n        else if (xitemId == 'deletePost')\n          app.deletePost();\n      }\n    }\n  },\n  //编辑回复\n  editPost: function() {\n    app.operationType = 'editPost';\n    app.editWin.show();\n    app.TITLE.hide();\n    app.editWin.setTitle('编辑回复');\n    app.CONTENT.setValue(app.currentDetailCell.getHTML());\n  },\n  //删除回复\n  deletePost: function() {\n    Wb.confirm('确定要删除该回复吗？', function() {\n      Wb.request({\n        url: 'm?xwl=dev/otherinfo/community/delete-post',\n        params: {\n          POST_ID: app.currentPostId,\n          TITLE_ID: app.tab1.getActiveTab().titleId\n        },\n        success: function(resp) {\n          app.currentPost.fadeOut({\n            opacity: 0,\n            easing: 'easeOut',\n            duration: 300,\n            remove: true\n          });\n        }\n      });\n    });\n  }\n});"}}],"roles":{},"title":"开发社区","iconCls":"script_icon","inframe":false,"pageLink":""}