{"hidden":true,"children":[{"configs":{"itemId":"module","serverScript":"app.execute('m?xwl=dev/datainfo/SQL/dbm/utils');\nvar params = app.get();\nif (params.type == 'table') {\n  pasteTable();\n}\n\n//粘贴表\nfunction pasteTable() {\n  var rs = app.run('select * from ' + params.prefix + '.' + params.quoteChar + params.text + params.quoteChar, {\n      jndi: params.jndi\n    }),\n    conn = DbUtil.getConnection(request, params.newJndi),\n    sqlTpl = app.getSqlTpl(conn),\n    meta = rs.getMetaData(),\n    closeQuietly = org.apache.commons.io.IOUtils.closeQuietly,\n    st, len, type, sql, fieldName, newFullTableName, is, types = [],\n    fieldNames = [],\n    i, j, k = 1;\n\n  function closeStream(item) {\n    closeQuietly(item);\n  }\n\n  j = meta.getColumnCount();\n  newFullTableName = params.newPrefix + '.' + params.newQuoteChar + params.newText + params.newQuoteChar;\n  sql = 'create table ' + newFullTableName + '(\\n';\n  for (i = 1; i <= j; i++) {\n    if (i > 1)\n      sql += ',\\n';\n    len = meta.getPrecision(i);\n    type = meta.getColumnType(i);\n    fieldName = params.newQuoteChar + meta.getColumnLabel(i) + params.newQuoteChar;\n    types.push(type);\n    fieldNames.push(fieldName);\n    //SQL Server 长度特殊处理\n    if (sqlTpl.tag.db == 'sqlserver' && len > 8000)\n      len = 'MAX';\n    //过长的字段串类型转clob类型\n    if (len > 8000) {\n      if (type == 12)\n        type = 2005;\n      if (type == -9)\n        type = 2011;\n    }\n    sql += fieldName + ' ' + Wb.format(sqlTpl.tag.fieldsMap[type], len, meta.getScale(i));\n    if (meta.isNullable(i) === 0)\n      sql += ' not null';\n  }\n  sql += '\\n)';\n  app.run(sql, {\n    jndi: params.newJndi\n  });\n  st = conn.prepareStatement('insert into ' + newFullTableName + '(' +\n    fieldNames.join(',') + ') values (?' + StringUtil.repeat(',?', j - 1) + ')');\n  while (rs.next()) {\n    isList = [];\n    try {\n      for (i = 1; i <= j; i++) {\n        type = types[i - 1];\n        if (DbUtil.isBlobField(type)) {\n          is = rs.getBinaryStream(i);\n          if (is) {\n            //在finally中关闭stream\n            isList.push(is);\n            st.setBinaryStream(i, is);\n          } else st.setNull(i, type);\n        } else DbUtil.setObject(st, i, type, DbUtil.getObject(rs, i, type));\n      }\n      DbUtil.addBatch(st);\n    } finally {\n      Wb.each(isList, closeStream);\n    }\n    if (k % 100 === 0)\n      st.executeBatch();\n    k++;\n  }\n  st.executeBatch();\n}"},"expanded":false,"children":[],"type":"module"}],"roles":{},"title":"粘贴对象","iconCls":"","inframe":false,"pageLink":""}