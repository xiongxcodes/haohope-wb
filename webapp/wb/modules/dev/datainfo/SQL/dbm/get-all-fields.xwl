{"hidden":true,"children":[{"configs":{"itemId":"module","serverScript":"app.execute('m?xwl=dev/datainfo/SQL/dbm/utils');\napp.loadObjectMap();\nvar conn, st, rs, objects, sqlTpl, jndi = app.get('jndi'),\n  object = app.getObject('object');\n\ntry {\n  conn = DbUtil.getConnection(jndi);\n  sqlTpl = app.getSqlTpl(conn);\n  st = conn.createStatement();\n  objects = getObjects();\n  if (object.table && object.prefix) {\n    objects[object.prefix] = getFields();\n  }\n} catch (e) {} finally {\n  DbUtil.close(rs);\n  DbUtil.close(st);\n  DbUtil.close(conn);\n}\napp.send(objects);\n\nfunction getFields() {\n  var meta, sql, i, j, pos, tableSchema, tableName, fields = [];\n  if (sqlTpl.fieldHint) {\n    pos = object.table.indexOf('.');\n    if (pos == -1) {\n      tableSchema = app.getDefaultPrefix(sqlTpl.tag.prefix, jndi);\n      tableName = object.table;\n    } else {\n      tableSchema = object.table.substring(0, pos);\n      tableName = object.table.substring(pos + 1);\n    }\n    sql = StringUtil.replaceAll(sqlTpl.fieldHint, '{' + '#prefix#' + '}', tableSchema);\n    sql = StringUtil.replaceAll(sql, '{' + '#table#' + '}', tableName);\n    app.log(sql);\n    rs = st.executeQuery(sql);\n    while (rs.next()) {\n      fields.push(rs.getString(1) + '\\n' + (rs.getString(2) || ''));\n    }\n  } else {\n    rs = st.executeQuery('select * from ' + object.table + ' where 1=0');\n    meta = rs.getMetaData();\n    j = meta.getColumnCount() + 1;\n    for (i = 1; i < j; i++) {\n      fields.push(meta.getColumnLabel(i));\n    }\n  }\n  return fields;\n}\n\nfunction getObjects() {\n  var result, meta, objName, mulCol;\n\n  function getNames(sql, isPrefix) {\n    var name, names = [],\n      st, obj, rs, jndiPrefix;\n\n    if (isPrefix)\n      jndiPrefix = jndi + '.';\n    else\n      jndiPrefix = jndi + '.' + object.prefix + '.';\n    try {\n      st = conn.createStatement();\n      sql = StringUtil.replaceAll(sql, '{' + '#prefix#' + '}', object.prefix);\n      rs = st.executeQuery(sql);\n      meta = rs.getMetaData();\n      mulCol = meta.getColumnCount() > 1;\n      while (rs.next()) {\n        name = rs.getString(1);\n        if (!app.isAdmin) {\n          obj = app.allObjectMap[jndiPrefix + name];\n          if (!obj || !Wb.across(app.roles, obj['1']))\n            continue;\n        }\n        if (mulCol) {\n          objName = rs.getString(2);\n          //去掉无意义的view注释\n          if ((objName || '').toLowerCase() == 'view')\n            objName = '';\n          names.push(name + '\\n' + (objName || ''));\n        } else\n          names.push(name);\n      }\n    } finally {\n      DbUtil.close(rs);\n      DbUtil.close(st);\n    }\n    return names;\n  }\n\n  if (!sqlTpl) {\n    return {};\n  }\n  result = Wb.toObject(getNames(sqlTpl.prefix, true));\n  if (object.prefix)\n    result[object.prefix] = Wb.unique(Wb.merge(getNames(sqlTpl.table), getNames(sqlTpl.view),\n      getNames(sqlTpl.sp)));\n  return result;\n}"},"expanded":true,"children":[],"type":"module"}],"roles":{},"title":"获取所有字段","iconCls":"","inframe":false,"pageLink":""}