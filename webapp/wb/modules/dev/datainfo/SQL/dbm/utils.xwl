{"hidden":true,"children":[{"configs":{"itemId":"module","serverScript":"Wb.apply(app, {\n  //是否为管理员\n  isAdmin: StringUtil.indexOf(app.get('sys.roles'), 'admin') != -1,\n  //当前角色\n  roles: (function() {\n    var roleList = \"'\" + StringUtil.join(app.get('sys.roles'), \"','\") + \"'\";\n    var recs = app.getRecords('select ROLE_NAME from WB_ROLE where ROLE_ID in (' + roleList + ')');\n    return Wb.pluck(recs, 'ROLE_NAME');\n  })(),\n  //基本实体类型\n  basicTypes: Wb.toObject(['table', 'view', 'sp', 'fn', 'tr']),\n  /**\n   * 获得删除对象的SQL语句。\n   * @return {String} SQL语句。\n   */\n  getDropScript: function() {\n    var sql, type = app.get('type'),\n      dbType = app.get('dbType'),\n      prefix = app.get('prefix') + '.',\n      fullTableName = app.get('fullTableName');\n    switch (type) {\n      case 'table':\n        sql = 'drop table ' + fullTableName;\n        break;\n      case 'view':\n        sql = 'drop view ' + app.get('fullViewName');\n        break;\n      case 'sp':\n        sql = 'drop procedure ' + app.get('fullSpName');\n        break;\n      case 'fn':\n        sql = 'drop function ' + app.get('fullFnName');\n        break;\n      case 'tr':\n        sql = 'drop trigger ' + app.get('fullTrName');\n        break;\n      case 'idx':\n        var fullIdxName = app.get('fullIdxName');\n        if (app.get('iconCls') == 'key_icon') {\n          //主键\n          sql = Wb.format(sqlTpl.tag.dropPk, fullTableName, fullIdxName);\n        } else {\n          if (dbType == 'oracle')\n            sql = 'drop index ' + fullIdxName;\n          else\n            sql = 'drop index ' + fullIdxName + ' on ' + fullTableName;\n        }\n        break;\n      case 'field':\n        sql = 'alter table ' + fullTableName + ' drop column ' + app.get('fullFieldName');\n        break;\n    }\n    return sql;\n  },\n  /**\n   * 获得当前数据库类型的SQL模板对象。\n   * @param {Connection} conn 数据库连接对象。\n   * @return {Object} SQL模板对象。\n   */\n  getSqlTpl: function(conn) {\n    var bufName = 'sys.utilities.dbm.json';\n    var result = null,\n      dbmObject = Wb.readJson(new File(Base.path, 'wb/system/database/dbm.json')),\n      dbName = conn.getMetaData().getDatabaseProductName().toLowerCase();\n    Wb.each(dbmObject, function(name, obj) {\n      name = name.toLowerCase();\n      if (dbName.indexOf(name) != -1) {\n        result = obj;\n        return false;\n      }\n    });\n    return result;\n  },\n  /**\n   * 是否具有指定操作的权限。\n   */\n  canAccess: function(objectName, type) {\n    // || currentType && !app.basicTypes[currentType]\n    if (app.isAdmin)\n      return true;\n    var obj = app.allObjectMap[objectName];\n    if (!obj)\n      return false;\n    return Wb.across(app.roles, obj[type]);\n  },\n  /**\n   * 是否可以显示指定的前缀。\n   */\n  canShowPrefix: function(prefix) {\n    if (app.isAdmin)\n      return true;\n    var found = false;\n    prefix = prefix + '.';\n    Wb.each(app.allObjectMap, function(k, v) {\n      if (k.startsWith(prefix)) {\n        if (Wb.across(app.roles, v[1])) {\n          found = true;\n          return false;\n        }\n      }\n    });\n    return found;\n  },\n  /**\n   * 加载权限和对象列表。\n   */\n  loadObjectMap: function(objectName) {\n    var recs, obj;\n    if (objectName) {\n      app.set('OBJECT_NAME', objectName);\n      recs = app.getRecords('select OBJECT_NAME,ROLE_NAME,PERM_TYPE from WB_DBM where OBJECT_NAME={?OBJECT_NAME?}');\n    } else\n      recs = app.getRecords('select OBJECT_NAME,ROLE_NAME,PERM_TYPE from WB_DBM');\n    app.allObjectMap = {};\n    Wb.each(recs, function(rec) {\n      obj = app.allObjectMap[rec.OBJECT_NAME];\n      if (!obj) {\n        obj = {\n          '1': [],\n          '2': [],\n          '3': []\n        };\n        app.allObjectMap[rec.OBJECT_NAME] = obj;\n      }\n      obj[rec.PERM_TYPE].push(rec.ROLE_NAME);\n    });\n  },\n  /**\n   * 获取默认前缀名称。\n   */\n  getDefaultPrefix: function(sql, jndi) {\n    var rs = app.run(sql, {\n      jndi: jndi\n    });\n    rs.next();\n    return rs.getString(1);\n  }\n});","internalCall":"true"},"expanded":false,"children":[],"type":"module"}],"roles":{"default":1},"title":"公共方法","iconCls":"","inframe":false,"pageLink":""}