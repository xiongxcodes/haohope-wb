Ext.define("Wb.draw.DragSelector",{init:function(a){this.panel=a;a.mon(a,{beforecontainerclick:this.cancelClick,scope:this,render:{fn:this.onRender,scope:this,single:true}})},onRender:function(){this.tracker=Ext.create("Ext.dd.DragTracker",{panel:this.panel,el:this.panel.body,dragSelector:this,onBeforeStart:this.onBeforeStart,onStart:this.onStart,onDrag:this.onDrag,onEnd:this.onEnd});this.dragRegion=Ext.create("Ext.util.Region")},onBeforeStart:function(a){return a.target==this.panel.paper.canvas},onStart:function(a){var b=this.dragSelector;this.dragging=true;b.fillRegions();b.getProxy().show()},cancelClick:function(){return !this.tracker.dragging},onDrag:function(h){var k=this,a=k.panel,c=k.dragSelector,n=c.dragRegion,m=c.bodyRegion,j=c.getProxy(),i=k.startXY,p=k.getXY(),f=Math.min(i[0],p[0]),d=Math.min(i[1],p[1]),b=Math.abs(i[0]-p[0]),o=Math.abs(i[1]-p[1]),l,g;Ext.apply(n,{top:d,left:f,right:f+b,bottom:d+o});n.constrainTo(m);j.setRegion(n);a.items.each(function(e){l=e.el.getRegion();g=n.intersect(l);a.select(e,g)})},onEnd:Ext.Function.createDelayed(function(a){var b=this.dragSelector;this.dragging=false;b.getProxy().hide()},1),getProxy:function(){if(!this.proxy){this.proxy=this.panel.body.createChild({tag:"div",cls:"x-view-selector"})}return this.proxy},fillRegions:function(){var a=this.panel;this.bodyRegion=a.body.getRegion()}});Ext.define("Wb.drag.drawComp",{alias:"widget.drawcomp",extend:"Ext.panel.Panel",layout:"absolute",cls:"wb_design x-unselectable",isFlow:true,initComponent:function(){var a=this;if(!a.disableDesign){a.plugins=Ext.create("Wb.draw.DragSelector")}a.callParent()},afterRender:function(){var a=this;a.callParent();a.paper=new Raphael(a.body.dom.id,a.body.getWidth(),a.body.getHeight());if(!a.disableDesign){a.mon(a.body,"mousedown",function(f,d){var b,c=null;a.fireEvent("beforemousedown",a,c);b=Ext.fly(d);a.startMouseXY=f.getXY();if(d.pathComp){c=d.pathComp}else{if(d.parentNode&&d.parentNode.pathComp){c=d.parentNode.pathComp}else{if(b.hasCls("x-component")){c=Ext.getCmp(b.getAttribute("id"))}a.allowMouseUp=a.fireEvent("mousedown",a,c)!==false}}if(c){if(f.shiftKey){a.select(c,!c.selected)}else{if(!c.selected){a.deselectAll(c)}}}else{if(!a.isResizer(d)){a.deselectAll()}}});a.mon(a.body,"mouseup",function(g,f){var d=g.getXY(),b=Ext.fly(f),c=null;if(b.hasCls("x-component")){c=Ext.getCmp(b.getAttribute("id"))}if(a.allowMouseUp&&!f.pathComp){a.fireEvent("mouseup",a,c,a.startMouseXY[0]-a.getX(),a.startMouseXY[1]-a.getY(),d[0]-a.startMouseXY[0],d[1]-a.startMouseXY[1])}})}a.mon(a,"resize",function(c,d,b){a.paper.setSize(d,b)})},rect:function(c,e){c=Wb.apply({color:"#000",fontSize:12,backColor:"#eee"},c);var f=this,b=f.paper,j=Ext.Number.snap(c.x,8),h=Ext.Number.snap(c.y,8),a=Ext.Number.snap(c.width||120,8),k=Ext.Number.snap(c.height||24,8),i,g,d,l;g=b.rect(j,h,a,k,10);g.attr({fill:c.backColor,stroke:"#aaa","stroke-width":1});d=b.image("wb/images/"+(c.iconCls||"null")+".png",j+10,h+k/2-8,16,16);i=b.text(j,h,c.name);i.attr({"font-size":c.fontSize,fill:c.color});l=f.addMask(g,i,d,c);if(e){f.select(l)}f.fireEvent("changed",f);return l},adjustLabelIconPos:function(c){var e=c.pathInfo,a=e.x,d=e.y,b=e.nl;if(b){c.label.attr({x:a,y:d});c.image.attr({x:a-8,y:d-28})}else{c.label.attr({x:a,y:c.image.attrs.src=="wb/images/null.png"?d:(d+13)});c.image.attr({x:a-8,y:d-15})}},reloadPath:function(b){var a=this,c=a.getPath(b.srcNode,b.dstNode,b.props.beeline);b.pathInfo=c;b.attr({path:c.path});b.maskPath.attr({path:c.path});a.adjustLabelIconPos(b)},adjustSize:function(){var e=this,g=e.rect,h=e.label,c=e.image,i=e.getLocalX(),f=e.getLocalY(),a=e.getWidth(),j=e.getHeight(),k,d;function b(){k.attr({path:d.path});k.maskPath.attr({path:d.path});e.ownerCt.adjustLabelIconPos(k)}Ext.suspendLayouts();g.attr({x:i,y:f,width:a,height:j});h.attr({x:i+a/2,y:f+j/2});c.attr({x:i+10,y:f+j/2-8});Wb.each(e.toNodes,function(l){k=e.paths[l.id];k.pathInfo=d=e.ownerCt.getPath(e,l,k.props.beeline);b()});Wb.each(e.fromNodes,function(l){k=l.paths[e.id];k.pathInfo=d=e.ownerCt.getPath(l,e,k.props.beeline);b()});e.ownerCt.fireEvent("changed",e);Ext.resumeLayouts(true)},removeNode:function(a){var b=this;b.deselect(a);if(a instanceof Ext.Component){if(a.paths){Wb.each(a.paths,function(c,d){if(d){b.removeNode(d)}},true)}if(a.fromNodes){Wb.each(a.fromNodes,function(c){if(c){b.removeNode(c.paths[a.id])}},true)}a.label.remove();a.image.remove();a.rect.remove();b.remove(a)}else{a.maskPath.remove();a.label.remove();a.image.remove();Ext.Array.remove(a.srcNode.toNodes,a.dstNode);Ext.Array.remove(a.dstNode.fromNodes,a.srcNode);delete a.srcNode.paths[a.dstNode.id];a.remove()}b.fireEvent("changed",b)},removeSelection:function(){var b=this,a=b.getSelection();Ext.suspendLayouts();Wb.each(a,function(c){b.removeNode(c)});Ext.resumeLayouts()},removeAll:function(){var a=this;a.items.each(function(b){a.removeNode(b)})},selectAll:function(){var a=this;a.setSelection(a.getItems())},deselectAll:function(b){var a=this;this.items.each(function(c){if(c==b&&!c.selected){a.select(c)}else{a.deselect(c)}if(c.paths){Wb.each(c.paths,function(d,e){if(e==b&&!e.selected){a.select(e)}else{a.deselect(e)}})}})},deselect:function(a){this.select(a,false)},getSelection:function(){return this.getItems(true)},setSelection:function(a,c){var b=this;if(Wb.getBool(c,true)){b.deselectAll()}Wb.each(a,function(d){b.select(d)})},getItems:function(b){var a=[];this.items.each(function(c){if(c.paths){Wb.each(c.paths,function(d,e){if(!b||e.selected){Wb.apply(e.props,{from:e.srcNode.props.name,to:e.dstNode.props.name});a.push(e)}})}});this.items.each(function(c){if(!b||c.selected){Wb.apply(c.props,{x:c.getLocalX(),y:c.getLocalY(),width:c.getWidth(),height:c.getHeight()});a.push(c)}});return a},findItem:function(b){var a=null,c=this;Wb.each(c.getItems(),function(d){if(d.isNode&&d.props.name==b){a=d;return false}});return a},findPath:function(c,d){var a=null,b=this;Wb.each(b.getItems(),function(e){if(e.isPath&&e.srcNode.props.name==c&&e.dstNode.props.name==d){a=e;return false}});return a},select:function(c,d){var e=this;d=Wb.getBool(d,true);if(c.selected===d){return}c.selected=d;if(c instanceof Ext.Component){if(c.resizer){var b,f=c.resizer,a=f.possiblePositions;Ext.suspendLayouts();Wb.each(a,function(g,h){b=f[h];if(d){b.show()}else{b.hide()}});Ext.resumeLayouts(true)}else{if(d&&!e.disableDesign){c.initResizable({handles:"all",pinned:true,widthIncrement:8,heightIncrement:8,listeners:{}})}}}else{if(c.selected){c.attr({"stroke-width":3})}else{c.attr({"stroke-width":2})}}this.fireEvent("selectionchange",c,d)},addMask:function(f,d,g,c){var e=this,a=f.attrs,b;b=e.add({xtype:"box",isMask:true,x:a.x,y:a.y,rect:f,label:d,isNode:true,image:g,props:c,width:a.width,height:a.height,style:e.disableDesign?"":"cursor:move;",draggable:e.disableDesign?false:{listeners:{drag:function(l,k){var j=l.lastXY,i=Ext.Number.snap(j[0]-l.startXY[0],8),h=Ext.Number.snap(j[1]-l.startXY[1],8);Ext.suspendLayouts();e.items.each(function(n){if(n.selected){var m=n.originXY[0]+i,o=n.originXY[1]+h;n.setLocalXY(m,o);n.fireEvent("move",n,m,o)}});Ext.resumeLayouts(true)},mousedown:function(i,h){if(e.isResizer(h.target)){return false}i.startXY=i.lastXY;e.items.each(function(j){j.originXY=j.getLocalXY()})}}},listeners:{resize:this.adjustSize,move:this.adjustSize}});return b},isResizer:function(a){return Ext.fly(a).hasCls("x-resizable-handle")},getPoints:function(d){var a=d.getLocalX(),g=d.getLocalY(),c=d.getWidth(),f=d.getHeight(),b=a+c/2,e=g+f/2;return[[b,g],[a+c,e],[b,g+f],[a,e]]},getPath:function(a,h,b){var i=this.getPoints(a),g=this.getPoints(h),c=[],e,j;function f(l,k){return(l[0]-k[0])*(l[0]-k[0])+(l[1]-k[1])*(l[1]-k[1])}function d(t,z,l){var p,o,y,s,q,k,D,n,m,v,u,r,A,w,x,B=false,C=10;r=Wb.indexOf(i,t);A=Wb.indexOf(g,z);s=r%2===0;q=A%2===0;k=t[0];D=t[1];n=z[0];m=z[1];if(Math.abs(k-n)<C&&Math.abs(D-m)<C){if(k<n){n=k+C}else{n=k-C}if(D<m){m=D+C}else{m=D-C}}v=k+(n-k)/2;u=D+(m-D)/2;p=v;o=u;if(l){return{path:"M"+k+" "+D+" L"+n+" "+m,x:v,y:u}}switch(r){case 0:if(m>D){return null}break;case 1:if(n<k){return null}break;case 2:if(m<D){return null}break;case 3:if(n>k){return null}break}switch(A){case 0:if(m<D){return null}break;case 1:if(n>k){return null}break;case 2:if(m>D){return null}break;case 3:if(n<k){return null}break}y="M"+k+" "+D+" L";if(s){if(q){if(Math.abs(u-D)<C||Math.abs(m-u)<C){return null}if(k!=n){B=true;o=u-12}y+=k+" "+u+" L"+n+" "+u}else{if(Math.abs(m-D)<C||Math.abs(n-k)<C){return null}p=k;y+=k+" "+m}}else{if(q){if(Math.abs(n-k)<C||Math.abs(m-D)<C){return null}p=n;y+=n+" "+D}else{if(Math.abs(v-k)<C||Math.abs(n-v)<C){return null}y+=v+" "+D+" L"+v+" "+m}}y+=" L"+n+" "+m;if(D==m){B=true;o=u-12}return{path:y,x:p,y:o,nl:B}}Wb.each(i,function(k){Wb.each(g,function(l){c.push([k,l])})});e=Ext.Array.sort(c,function(n,l){var k=f(n[0],n[1]),m=f(l[0],l[1]);return(k<m)?-1:((k==m)?0:1)});if(b){return d(e[0][0],e[0][1],true)}Wb.each(e,function(k){j=d(k[0],k[1]);if(j){return false}});if(j){if(h.paths&&h.paths[a.id]){srcPath=j.path;dstPath=h.paths[a.id].pathInfo.path;if(dstPath.substring(1,dstPath.indexOf(" L"))==srcPath.substring(srcPath.lastIndexOf("L")+1)&&srcPath.substring(1,srcPath.indexOf(" L"))==dstPath.substring(dstPath.lastIndexOf("L")+1)){j=d(e[2][0],e[2][1])}}}if(!j){return d(e[0][0],e[0][1],true)}return j},link:function(a,h,c){c=Wb.apply({color:"#000",fontSize:12,backColor:"#bbb",beeline:false,lineTitle:""},c);if(a.paths&&a.paths[h.id]){return}var m,f,l,e,i=this,b=i.paper,g=i.getPath(a,h,c.beeline),d=g.path,k=g.x,j=g.y;l=b.text(k,j,c.lineTitle);l.toBack();l.attr({"font-size":c.fontSize,cursor:i.disableDesign?"default":"pointer",fill:c.color});e=b.image("wb/images/"+(c.iconCls||null)+".png",k-8,j-15,16,16);e.toBack();e.attr({cursor:i.disableDesign?"default":"pointer"});m=b.path(d);m.pathInfo=g;m.toBack();m.attr({"arrow-end":"classic-wide-long",stroke:c.backColor,"stroke-width":2});m.selected=false;m.srcNode=a;m.dstNode=h;m.isPath=true;m.props=c;m.maskPath=f=b.path(d);f.attr({opacity:0,cursor:i.disableDesign?"default":"pointer","stroke-width":16});f.bindPath=m;f.node.pathComp=m;m.label=l;l.node.pathComp=m;m.image=e;e.node.pathComp=m;if(!a.paths){a.paths={}}a.paths[h.id]=m;if(!a.toNodes){a.toNodes=[]}if(Wb.indexOf(a.toNodes,h)==-1){a.toNodes.push(h)}if(!h.fromNodes){h.fromNodes=[]}if(Wb.indexOf(h.fromNodes,a)==-1){h.fromNodes.push(a)}i.adjustLabelIconPos(m);i.fireEvent("changed",i)},preparePath:function(c){var b=[],a=[];Wb.each(c,function(d){if(d.isNode){b.push(d)}});Wb.each(b,function(d){if(d.paths){Wb.each(d.paths,function(e,f){if(Wb.indexOf(b,f.dstNode)!=-1){a.push(f)}})}});return a.concat(b)},getData:function(d){var e=this,c=e.getItems(d),b=[],a=[];if(d){c=e.preparePath(c)}Wb.each(c,function(f){if(f.isNode){b.push(f.props)}else{a.push(f.props)}});return{nodes:b,links:a,flow:d?null:e.props}},load:function(c,d){if(!c){return}var a=this,b={};Wb.each(c.nodes,function(e){if(d){e=Wb.applyIf({x:e.x+d,y:e.y+d},e)}b[e.name]=a.rect(e)});Wb.each(c.links,function(e){a.link(b[e.from],b[e.to],e)},true);if(c.flow){a.props=c.flow}return Ext.Object.getValues(b)}});