{"hidden":false,"children":[{"configs":{"itemId":"module","serverScript":"app.set('rolesList', StringUtil.text(WbUtil.getModuleRoles()));"},"expanded":true,"children":[{"configs":{"itemId":"userNameControl","file":"m?xwl=sys/app/user/username-control"},"expanded":false,"children":[],"type":"xwl"},{"configs":{"itemId":"editWin","focusControl":"USER_NAME","editWin":"true","width":"648","layoutType":"vboxForm"},"expanded":false,"children":[{"configs":{"itemId":"container1","padding":"0","layoutType":"tableColumn2"},"expanded":true,"children":[{"configs":{"itemId":"USER_NAME","headerScript":"Wb.apply(app.userNameControl.USER_NAME, {\n  appScope: app\n}),"},"expanded":false,"children":[],"type":"clientscript"},{"configs":{"allowBlank":"false","itemId":"DISPLAY_NAME","labelAlign":"right","fieldLabel":"显示名称"},"expanded":false,"children":[],"type":"text"},{"configs":{"allowBlank":"false","itemId":"PASSWORD","labelAlign":"right","minLength":"6","fieldLabel":"密码","inputType":"password"},"expanded":false,"children":[],"type":"text"},{"configs":{"allowBlank":"false","itemId":"RE_PASSWORD","labelAlign":"right","minLength":"6","fieldLabel":"密码确认","inputType":"password"},"expanded":false,"children":[],"type":"text"},{"configs":{"itemId":"EMAIL","vtype":"email","labelAlign":"right","fieldLabel":"电子邮件"},"expanded":false,"children":[],"type":"text"},{"configs":{"tagConfigs":"{\n  getValue: function() {\n    var vals = Wb.getValue(this, ['radio1', 'radio2']);\n    if (vals.radio1)\n      return 1;\n    else if (vals.radio2)\n      return 0;\n    else return null;\n  },\n  setValue: function(v) {\n    Wb.setValue(this, {\n      radio1: v == 1,\n      radio2: v === 0\n    });\n  }\n}","layout":"hbox","itemId":"STATUS","labelAlign":"right","fieldLabel":"状态"},"expanded":true,"children":[{"configs":{"itemId":"radio1","boxLabel":"启用","flex":"1","name":"boolField","checked":"true"},"expanded":false,"children":[],"type":"radio"},{"configs":{"itemId":"radio2","boxLabel":"停用","flex":"1","name":"boolField"},"expanded":false,"children":[],"type":"radio"}],"type":"fieldcontainer"}],"type":"container"},{"configs":{"layout":"fit","itemId":"fieldset1","padding":"8","flex":"1","title":"角色","height":"230"},"expanded":true,"children":[{"configs":{"itemId":"roleGrid","selType":"checkboxmodel","sortableColumns":"false","simpleSelect":"true","pagingBar":"false","multiSelect":"true"},"expanded":true,"children":[{"configs":{"itemId":"store","remoteSort":"true","autoLoad":"true","pageSize":"-1","url":"m?xwl=admin/user/select-valid-roles"},"expanded":false,"children":[],"type":"store"}],"type":"grid"}],"type":"fieldset"}],"type":"window","events":{"ok":"if (app.PASSWORD.getValue() != app.RE_PASSWORD.getValue()) {\n  Wb.warn('两次密码输入不一致。',\n    function() {\n      app.PASSWORD.focus(true, true);\n    }\n  );\n  return;\n}\nvar values = Wb.getValue(app.editWin);\nif (app.isEdit) {\n  Wb.request({\n    url: 'm?xwl=admin/user/update',\n    params: Wb.applyIf(values, Wb.getData(app.selRec, true)),\n    success: function() {\n      Wb.update(app.selRec, Wb.apply(values, app.getRoleData()));\n      app.editWin.close();\n      app.changeUser(app.selRec);\n    }\n  });\n} else {\n  Wb.request({\n    url: 'm?xwl=admin/user/insert',\n    out: app.editWin,\n    success: function(resp) {\n      Wb.add(app.grid1, Wb.apply(Wb.decode(resp.responseText), values, app.getRoleData()));\n      app.editWin.close();\n    }\n  });\n}"}},{"configs":{"layout":"border","itemId":"viewport1"},"expanded":true,"children":[{"configs":{"itemId":"mainToolbar","region":"north"},"expanded":false,"children":[{"configs":{"itemId":"newBtn","tooltip":"添加新的用户 (Ctrl+E)","text":"添加","iconCls":"record_add_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.editWin.show();\napp.USER_NAME.exceptName = '';\napp.editWin.setTitle('添加用户帐户');\napp.editWin.setIconCls('record_add_icon');\napp.roleGrid.selModel.deselectAll();\napp.isEdit = false;"}},{"configs":{"itemId":"editBtn","tooltip":"修改选择的用户","text":"修改","iconCls":"record_edit_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"var sels = app.grid1.getSelection();\nif (sels.length != 1) {\n  Wb.warn('请选择 1 条需要修改的记录。');\n  return;\n}\napp.selRec = sels[0];\napp.editWin.show();\napp.USER_NAME.exceptName = app.selRec.data.USER_NAME; //检测用户名称时排除该名称\napp.editWin.setTitle('修改 - ' + app.selRec.data.DISPLAY_NAME);\napp.editWin.setIconCls('record_edit_icon');\nWb.setValue(app.editWin, Wb.applyIf({\n  PASSWORD: '******',\n  RE_PASSWORD: '******'\n}, app.selRec.data));\nselectRole();\napp.isEdit = true;\napp.USER_NAME.focus(false, true);\n\n//选中编辑窗口中的角色记录\nfunction selectRole() {\n  var selRecs = [],\n    roles = Wb.decode(app.selRec.data.ROLE_IDS);\n  app.roleGrid.store.each(function(rec) {\n    if (Wb.indexOf(roles, rec.data.ROLE_ID) != -1)\n      selRecs.push(rec);\n  });\n  app.roleGrid.setSelection(selRecs);\n}"}},{"configs":{"itemId":"delBtn","tooltip":"删除选择的用户","text":"删除","iconCls":"record_delete_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.del(app.grid1, {\n  url: 'm?xwl=admin/user/delete',\n  titleField: 'DISPLAY_NAME'\n});"}},{"configs":{"itemId":"item1","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"disableBtn","tooltip":"停用当前选择的所有用户","text":"停用","iconCls":"minus_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.setStatus(0);"}},{"configs":{"itemId":"enableBtn","tooltip":"启用当前选择的所有用户","text":"启用","iconCls":"accept_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.setStatus(1);"}},{"configs":{"itemId":"item2","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"findCombo","onTriggerClick":"this.collapse();\nif (app.selRoleGrid.rendered)\n  app.selRoleGrid.selModel.deselectAll();\napp.grid1.store.load({\n  out: app.mainToolbar\n});","emptyText":"用户名称","triggerCls":"x-form-search-trigger","width":"150","displayField":"USER_NAME","enterKeyTriggerClick":"true"},"expanded":true,"children":[{"configs":{"itemId":"store","url":"m?xwl=admin/user/user-list"},"expanded":false,"children":[],"type":"store"}],"type":"combo","events":{"select":"app.findCombo.onTriggerClick();"}},{"configs":{"itemId":"rolesMenu","text":"搜索角色"},"expanded":true,"children":[{"configs":{"itemId":"selRoleGrid","selType":"checkboxmodel","sortableColumns":"false","simpleSelect":"true","pagingBar":"false","width":"500","multiSelect":"true","height":"230"},"expanded":true,"children":[{"configs":{"itemId":"store","remoteSort":"true","autoLoad":"true","pageSize":"-1","url":"m?xwl=admin/user/select-all-roles"},"expanded":false,"children":[],"type":"store"}],"type":"grid","events":{"selectionchange":"app.userStore.load();"}}],"type":"item"},{"configs":{"itemId":"statusMenu","text":"搜索状态"},"expanded":true,"children":[{"configs":{"itemId":"disabledStatusItem","checked":"false","text":"停用","group":"status"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"enabledStatusItem","checked":"false","text":"启用","group":"status"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"allStatusItem","checked":"true","text":"全部","group":"status"},"expanded":false,"children":[],"type":"item"}],"type":"item","events":{"menuclick":"app.userStore.load();"}},{"configs":{"itemId":"resetFindBtn","tooltip":"重置搜索条件","text":"重置搜索","iconCls":"undo_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"if (app.selRoleGrid.rendered)\n  app.selRoleGrid.selModel.deselectAll();\nWb.reset(app.mainToolbar);\napp.allStatusItem.setChecked(true);\napp.userStore.load();"}},{"configs":{"itemId":"item3","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"permsBtn","tooltip":"查看/隐藏选择用户的访问权限","text":"访问权限","iconCls":"option_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"var notVisible = !app.modules.isVisible();\napp.modules.setVisible(notVisible);\nif (notVisible)\n  app.changeUser();"}}],"type":"toolbar"},{"configs":{"itemId":"modules","split":"true","closable":"true","root":"{\n  fileName: 'Root'\n}","closeAction":"hide","width":"380","region":"east","title":"访问权限 - (未选择用户)","rootVisible":"false","multiSelect":"true"},"expanded":true,"children":[{"configs":{"itemId":"store","fields":"['text', 'path', 'fileName']","url":"m?xwl=admin/user/module-list"},"expanded":false,"children":[],"type":"treestore","events":{"beforeload":"operation.params.path = operation.node.data.path;"}},{"configs":{"itemId":"tbar","enableOverflow":"true"},"expanded":false,"children":[{"configs":{"itemId":"combo","onTriggerClick":"app.modules.selectPath('/Root/' + this.getValue(), 'fileName');","emptyText":"模块","flex":"1","triggerCls":"x-form-search-trigger","displayField":"title","enterKeyTriggerClick":"true","listConfig":"{\n  itemTpl: [\n    '<div>{fullPath}<\/div>'\n  ]\n}","valueField":"fullFile"},"expanded":true,"children":[{"configs":{"itemId":"store","fields":"['path', 'title', 'file', 'parentFile', {\n  name: 'fullPath',\n  convert: function(v, rec) {\n    var data = rec.data;\n    if (data.path)\n      return data.path.substring(1) + '/' + data.title;\n    else return data.title;\n  }\n}, {\n  name: 'fullFile',\n  convert: function(v, rec) {\n    var data = rec.data;\n    if (data.parentFile)\n      return data.parentFile.substring(1) + '/' + data.file;\n    else return data.file;\n  }\n}]","url":"m?xwl=admin/user/search-module"},"expanded":false,"children":[],"type":"store"}],"type":"combo","events":{"beforequery":"if (plan.query.indexOf('/') != -1 || plan.query.indexOf('\\\\') != -1) {\n  plan.combo.collapse();\n  return false;\n}","select":"combo.onTriggerClick();"}},{"configs":{"itemId":"item","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"expandAllBtn","tooltip":"展开选择模块的全部子模块","text":"展开"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.mask(null, null, 1);\nsetTimeout(function() {\n  Wb.expand(app.modules);\n  Wb.unmask();\n}, 50);"}},{"configs":{"itemId":"collapseAllBtn","tooltip":"收缩选择模块的全部子模块","text":"收缩"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.collapse(app.modules);"}}],"type":"toolbar"}],"type":"tree","events":{"itemexpand":"app.setModules(node);"}},{"configs":{"itemId":"grid1","syncStateId":"sys.user","sortableColumns":"false","region":"center","multiSelect":"true"},"expanded":true,"children":[{"configs":{"itemId":"store","remoteSort":"true","normalName":"userStore","autoLoad":"true","sorters":"'USER_NAME'","url":"m?xwl=admin/user/select"},"expanded":false,"children":[],"type":"store","events":{"beforeload":"var status;\nif (app.disabledStatusItem.checked)\n  status = 0;\nelse if (app.enabledStatusItem.checked)\n  status = 1;\nelse\n  status = null;\nWb.apply(operation.params, {\n  roles: app.selRoleGrid.getValue(), //grid的submitSelect属性默认为true获取选择记录，否则获取全部记录\n  status: status\n});"}}],"type":"grid","events":{"selectionchange":"app.changeUser(selected[0]);","itemdblclick":"app.editBtn.fireEvent('click');"}}],"type":"viewport","events":{"afterrender":"app.navKey = new Ext.KeyNav({\n  viewport: app.viewport1,\n  E: {\n    ctrl: true,\n    fn: function() {\n      app.newBtn.fireEvent('click');\n    }\n  }\n});"}}],"type":"module","events":{"initialize":"Wb.apply(app, {\n  //模块角色数据\n  rolesList: Wb.decode(\"{#rolesList#}\"),\n  //更新当前选择用户的模块权限列表\n  setModules: function(baseNode) {\n    var hasPerm, roles, checked, allChecked = true,\n      allUnchecked = true,\n      hasAdmin = Wb.indexOf(app.currentRoles, 'admin') != -1,\n      rolesList = app.rolesList;\n    Ext.suspendLayouts();\n    baseNode.eachChild(function(node) {\n      if (!node.data.depth)\n        return;\n      if (node.isLeaf()) {\n        if (hasAdmin)\n          hasPerm = true;\n        else {\n          roles = rolesList[node.data.path];\n          hasPerm = false;\n          if (roles && app.currentRoles) {\n            Wb.each(app.currentRoles, function(role) {\n              if (roles[role]) {\n                hasPerm = true;\n                return false;\n              }\n            });\n          }\n        }\n        Wb.setChecked(node, hasPerm, app.modules, true);\n        if (hasPerm)\n          allUnchecked = false;\n        else\n          allChecked = false;\n      } else {\n        checked = app.setModules(node);\n        if (checked === null) {\n          allChecked = false;\n          allUnchecked = false;\n        } else if (checked)\n          allUnchecked = false;\n        else\n          allChecked = false;\n      }\n    });\n    if (allChecked)\n      checked = true;\n    else if (allUnchecked)\n      checked = false;\n    else\n      checked = null;\n    Wb.setChecked(baseNode, checked, app.modules, true);\n    Ext.resumeLayouts(true);\n    return checked;\n  },\n  //指量设置用户状态\n  setStatus: function(status) {\n    var recs = app.grid1.getSelection();\n    Wb.confirmDo(recs, doSet, 'DISPLAY_NAME', status ? '启用' : '停用');\n\n    function doSet() {\n      Wb.request({\n        url: 'm?xwl=admin/user/set-status',\n        out: app.grid1,\n        params: {\n          newStatus: status\n        },\n        success: function(resp) {\n          Wb.each(recs, function(rec) {\n            rec.set('STATUS', status);\n          });\n          app.store.commitChanges();\n        }\n      });\n    }\n  },\n  //获得对话框角色中的角色id和名称组成的对象\n  getRoleData: function() {\n    var sels = app.roleGrid.getSelection();\n    return {\n      ROLES: Wb.pluck(sels, 'ROLE_NAME').join(', '),\n      ROLE_IDS: Wb.encode(Wb.pluck(sels, 'ROLE_ID'))\n    };\n  },\n  //切换用户时调用的方法\n  changeUser: function(rec) {\n    if (!rec)\n      rec = app.grid1.getSelection()[0];\n    if (!app.modules.isVisible())\n      return;\n    if (!rec) {\n      app.currentRoles = null;\n      Wb.setTitle(app.modules, '(未选择用户)');\n      app.setModules(app.modules.getRootNode());\n      return;\n    }\n    Wb.setTitle(app.modules, rec.data.DISPLAY_NAME);\n    app.currentRoles = Wb.decode(rec.data.ROLE_IDS);\n    app.currentRoles.push('default');\n    app.setModules(app.modules.getRootNode());\n  }\n});"}}],"roles":{},"title":"用户帐户","iconCls":"user_icon","inframe":false,"pageLink":""}