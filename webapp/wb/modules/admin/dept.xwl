{"hidden":false,"children":[{"configs":{"itemId":"module"},"expanded":true,"children":[{"configs":{"itemId":"editWin","editWin":"true","width":"416","layoutType":"anchorForm","defaultFocus":"DEPT_NAME"},"expanded":true,"children":[{"configs":{"itemId":"DEPT_ID","allowBlank":"false","labelAlign":"right","fieldLabel":"部门ID号","readOnly":"true"},"expanded":false,"children":[],"type":"text"},{"configs":{"allowBlank":"false","itemId":"DEPT_NAME","labelAlign":"right","fieldLabel":"部门名称"},"expanded":false,"children":[],"type":"text"}],"type":"window","events":{"beforeshow":"delete win.height;","ok":"app.doUpdate();"}},{"configs":{"layout":"border","itemId":"viewport1"},"expanded":true,"children":[{"configs":{"itemId":"toolbar1","region":"north"},"expanded":true,"children":[{"configs":{"itemId":"insertBtn","tooltip":"在当前节点下插入同级部门 (Ctrl+E)","text":"插入","iconCls":"insert_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.addDept(false);"}},{"configs":{"itemId":"addBtn","tooltip":"在当前节点下添加子部门","text":"添加","iconCls":"record_add_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.addDept(true);"}},{"configs":{"itemId":"editBtn","tooltip":"修改选择的部门","text":"修改","iconCls":"record_edit_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.editDept();"}},{"configs":{"itemId":"delBtn","tooltip":"删除选择的部门","text":"删除","iconCls":"record_delete_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"var nodes = app.tree1.getSelection();\nWb.confirmDo(nodes, function() {\n  var deptIds = {};\n  Wb.each(app.tree1.getSelection(), function(node) {\n    node.cascadeBy(function(item) {\n      deptIds[item.data.DEPT_ID] = {\n        DEPT_ID: item.data.DEPT_ID\n      };\n    });\n  });\n  Wb.request({\n    url: 'm?xwl=admin/dept/delete',\n    params: {\n      deptIds: Ext.Object.getValues(deptIds)\n    },\n    success: function(resp) {\n      Wb.remove(app.tree1);\n    }\n  });\n}, 'DEPT_NAME');"}},{"configs":{"itemId":"item1","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"refreshBtn","tooltip":"刷新部门列表","text":"刷新","iconCls":"refresh_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.reload(app.tree1, null, {\n  field: 'DEPT_ID'\n});"}}],"type":"toolbar"},{"configs":{"itemId":"tree1","root":"{\n  DEPT_ID: '0',\n  text:'全部部门',\n  expanded: true\n}","viewConfig":"app.treeViewConfig","region":"center","tools":"Wb.getTreeTools({search:true})","rootVisible":"true","multiSelect":"true"},"expanded":true,"children":[{"configs":{"itemId":"store","fields":"['text', 'DEPT_NAME', 'DEPT_ID', 'PARENT_DEPT', 'ORDER_INDEX']","url":"m?xwl=sys/app/dept/dept-tree-data"},"expanded":false,"children":[],"type":"treestore"}],"type":"tree","events":{"selectionchange":"app.selNodes = selected;\napp.selNode = selected[0];","itemdblclick":"app.editBtn.fireEvent('click');"}}],"type":"viewport","events":{"afterrender":"app.navKey = new Ext.KeyNav({\n  viewport: app.viewport1,\n  E: {\n    ctrl: true,\n    fn: function() {\n      app.insertBtn.fireEvent('click');\n    }\n  }\n});"}}],"type":"module","events":{"initialize":"Wb.apply(app, {\n  /**\n   * 在当前节点插入同级部门或添加子部门。\n   * @param {Boolean} isAdd 是否添加子部门。\n   */\n  addDept: function(isAdd) {\n    var title = isAdd ? '添加' : '插入';\n    app.DEPT_ID.hide();\n    app.editWin.show();\n    if (app.selNode)\n      app.editWin.setTitle(title + ' - ' + app.selNode.data.text);\n    else\n      app.editWin.setTitle(title);\n    app.editWin.setIconCls('record_add_icon');\n    if (isAdd)\n      app.editMode = 'add';\n    else\n      app.editMode = 'insert';\n  },\n  /**\n   * 修改当前选择的部门。\n   */\n  editDept: function() {\n    if (!app.selNode) {\n      Wb.warn('请选择 1 个部门。');\n      return;\n    }\n    if (app.selNode.isRoot()) {\n      Wb.warn('不能对根节点进行修改。');\n      return;\n    }\n    app.DEPT_ID.show();\n    app.editWin.show();\n    app.editWin.setTitle('修改 - ' + app.selNode.data.text);\n    app.editWin.setIconCls('record_edit_icon');\n    Wb.setValue(app.editWin, app.selNode.data);\n    app.editMode = 'update';\n  },\n  /**\n   * 执行修改或添加部门的更新操作。在editWin的ok事件中调用了该方法。\n   */\n  doUpdate: function() {\n    var values = Wb.getValue(app.editWin);\n    if (app.editMode == 'update') {\n      Wb.request({\n        url: 'm?xwl=admin/dept/update',\n        params: Wb.applyIf(values, Wb.getData(app.selNode, true)),\n        success: function() {\n          values.text = values.DEPT_NAME;\n          Wb.update(app.selNode, values);\n          app.editWin.close();\n        }\n      });\n    } else {\n      var parentDept, orderIndex, node, mode = app.editMode;\n      if (app.selNode)\n        node = app.selNode;\n      else {\n        //没有选择节点从根节点添加\n        node = app.tree1.getRootNode();\n        mode = 'add';\n      }\n      if (mode == 'add') {\n        //添加子部门\n        parentDept = node.data.DEPT_ID;\n        orderIndex = node.lastChild ? node.lastChild.data.ORDER_INDEX + 1 : 1;\n      } else {\n        //插入同级部门\n        parentDept = node.parentNode.data.DEPT_ID;\n        orderIndex = node.data.ORDER_INDEX + 1;\n      }\n      Wb.request({\n        url: 'm?xwl=admin/dept/insert',\n        params: Wb.apply({\n          PARENT_DEPT: parentDept,\n          ORDER_INDEX: orderIndex\n        }, values),\n        success: function(resp) {\n          var newNode = Wb.apply({\n            iconCls: 'db_field_icon',\n            text: values.DEPT_NAME,\n            ORDER_INDEX: orderIndex,\n            children: []\n          }, Wb.decode(resp.responseText));\n          if (mode == 'add')\n            Wb.append(newNode, node);\n          else\n            Wb.insertAfter(newNode, node);\n          app.editWin.close();\n        }\n      });\n    }\n  },\n  /**\n   * 部门树的配置选项，使其支持拖动操作以方便部门的调整。\n   */\n  treeViewConfig: {\n    plugins: {\n      ptype: 'treeviewdragdrop'\n    },\n    listeners: {\n      beforedrop: function(node, data, om, dp, dh) {\n        var i, index, parentNode, parentDept, selDepts, deptCount = data.records.length;\n        if (dp == 'append') {\n          parentNode = om;\n          index = om.lastChild ? om.lastChild.data.ORDER_INDEX + 1 : 1;\n        } else {\n          parentNode = om.parentNode;\n          index = dp == 'before' ? om.data.ORDER_INDEX : om.data.ORDER_INDEX + 1;\n        }\n        dh.wait = true;\n        parentDept = parentNode.data.DEPT_ID;\n        selDepts = Wb.getData(data.records);\n        i = 0;\n        Wb.each(selDepts, function(item) {\n          item.ORDER_INDEX = index + (i++);\n        });\n        Wb.request({\n          url: 'm?xwl=admin/dept/move',\n          params: {\n            index: index,\n            deptCount: deptCount,\n            parentDept: parentDept,\n            selDepts: selDepts\n          },\n          callback: function(a, succ) {\n            if (succ) {\n              dh.processDrop();\n              parentNode.eachChild(function(node) {\n                i = node.data.ORDER_INDEX;\n                if (i >= index)\n                  node.set('ORDER_INDEX', i + deptCount);\n              });\n              i = 0;\n              Wb.each(data.records, function(node) {\n                node.set('PARENT_DEPT', parentDept);\n                node.set('ORDER_INDEX', index + (i++));\n              });\n              app.tree1.store.commitChanges();\n              app.tree1.setSelection(data.records);\n            } else {\n              dh.cancelDrop();\n            }\n          }\n        });\n      }\n    }\n  }\n});"}}],"roles":{},"title":"部门管理","iconCls":"org_icon","inframe":false,"pageLink":""}