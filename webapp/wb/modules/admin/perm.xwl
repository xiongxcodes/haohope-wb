{"hidden":false,"children":[{"configs":{"itemId":"module","serverScript":"app.set('rolesList', StringUtil.text(WbUtil.getModuleRoles()));"},"expanded":true,"children":[{"configs":{"layout":"border","itemId":"viewport1"},"expanded":true,"children":[{"configs":{"itemId":"roles","split":"true","width":"200","region":"west","title":"角色列表","collapsible":"true","tools":"Wb.getTreeTools({search:true})","rootVisible":"false"},"expanded":true,"children":[{"configs":{"itemId":"store","url":"m?xwl=admin/perm/role-list"},"expanded":false,"children":[],"type":"treestore"}],"type":"tree","events":{"selectionchange":"var role = selected[0];\nif (role) {\n  app.modules.setDisabled(false);\n  app.currentRole = role.data.ROLE_ID;\n  app.setModules(app.modules.getRootNode());\n}"}},{"configs":{"itemId":"modules","root":"{\n  fileName: 'Root'\n}","disabled":"true","region":"center","rootVisible":"false","multiSelect":"true"},"expanded":true,"children":[{"configs":{"itemId":"store","fields":"['text', 'path', 'fileName']","url":"m?xwl=admin/perm/module-list"},"expanded":false,"children":[],"type":"treestore","events":{"beforeload":"operation.params.path = operation.node.data.path;"}},{"configs":{"itemId":"tbar","enableOverflow":"true"},"expanded":true,"children":[{"configs":{"itemId":"permitBatchBtn","tooltip":"允许访问选择的所有模块 (Ctrl/Shift 多选)","text":"批量允许","iconCls":"application_add_icon"},"expanded":true,"children":[],"type":"item","events":{"click":"app.setPerms(app.modules.getSelection(), true);"}},{"configs":{"itemId":"prohibitBatchBtn","tooltip":"禁止访问选择的所有模块 (Ctrl/Shift 多选)","text":"批量禁止","iconCls":"application_delete_icon"},"expanded":true,"children":[],"type":"item","events":{"click":"app.setPerms(app.modules.getSelection(), false);"}},{"configs":{"itemId":"item1","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"expandAllBtn","tooltip":"展开选择模块的全部子模块","text":"全部展开","iconCls":"plus_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.mask(null, null, 1);\nsetTimeout(function() {\n  Wb.expand(app.modules);\n  Wb.unmask();\n}, 50);"}},{"configs":{"itemId":"collapseAllBtn","tooltip":"收缩选择模块的全部子模块","text":"全部收缩","iconCls":"minus_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.collapse(app.modules);"}},{"configs":{"itemId":"item2","text":"-"},"expanded":true,"children":[],"type":"item"},{"configs":{"itemId":"combo","onTriggerClick":"app.modules.selectPath('/Root/' + this.getValue(), 'fileName');","emptyText":"模块","flex":"1","triggerCls":"x-form-search-trigger","displayField":"title","enterKeyTriggerClick":"true","listConfig":"{\n  itemTpl: [\n    '<div>{fullPath}<\/div>'\n  ]\n}","valueField":"fullFile"},"expanded":true,"children":[{"configs":{"itemId":"store","fields":"['path', 'title', 'file', 'parentFile', {\n  name: 'fullPath',\n  convert: function(v, rec) {\n    var data = rec.data;\n    if (data.path)\n      return data.path.substring(1) + '/' + data.title;\n    else return data.title;\n  }\n}, {\n  name: 'fullFile',\n  convert: function(v, rec) {\n    var data = rec.data;\n    if (data.parentFile)\n      return data.parentFile.substring(1) + '/' + data.file;\n    else return data.file;\n  }\n}]","url":"m?xwl=admin/user/search-module"},"expanded":false,"children":[],"type":"store"}],"type":"combo","events":{"beforequery":"if (plan.query.indexOf('/') != -1 || plan.query.indexOf('\\\\') != -1) {\n  plan.combo.collapse();\n  return false;\n}","select":"combo.onTriggerClick();"}}],"type":"toolbar"}],"type":"tree","events":{"selectionchange":"var module = selected[0];\napp.allows.setDisabled(!module);\nif (module) {\n  app.currentModule = module.data.path;\n  Wb.setTitle(app.allows, module.data.text);\n  app.setRoles(module);\n}","itemexpand":"if (app.currentRole)\n  app.setModules(node);","itemcollapse":"if (app.currentRole)\n  app.setModules(node);","beforecheckchange":"app.setPerms([node], checked);\nreturn false;"}},{"configs":{"itemId":"allows","split":"true","width":"260","disabled":"true","region":"east","title":"可访问","collapsible":"true","rootVisible":"false"},"expanded":true,"children":[{"configs":{"itemId":"store","url":"m?xwl=admin/perm/module-role-list"},"expanded":false,"children":[],"type":"treestore"}],"type":"tree","events":{"beforecheckchange":"app.setPerms([app.modules.getSelection()[0]], checked, node.data.ROLE_ID);\nreturn false;"}}],"type":"viewport"}],"type":"module","events":{"initialize":"Wb.apply(app, {\n  //模块角色数据\n  rolesList: Wb.decode(\"{#rolesList#}\"),\n  /**\n   * 设置批量模块权限，并立即设置写入后台。\n   * @param {NodeInterface[]} choice 选择的节点列表。\n   * @param {Boolean} checked 选择状态。\n   * @param {String [setRole] 设置的角色，默认为角色列表选择的角色。\n   */\n  setPerms: function(choice, checked, setRole) {\n    function doSetPerm() {\n      Wb.request({\n        url: 'm?xwl=admin/perm/set-perms',\n        params: {\n          path: Wb.pluck(nodes, 'path'),\n          role: role,\n          checked: checked\n        },\n        success: function() {\n          var roles, path;\n          Ext.suspendLayouts();\n          Wb.each(nodes, function(node) {\n            path = node.data.path;\n            roles = app.rolesList[path];\n            if (checked) {\n              if (!roles) {\n                roles = {};\n                app.rolesList[path] = roles;\n              }\n              roles[role] = 1;\n            } else {\n              if (roles)\n                delete roles[role];\n            }\n          });\n          app.setRoles(choice[0]);\n          app.setModules(app.modules.getRootNode());\n          Ext.resumeLayouts(true);\n        }\n      });\n    }\n    var nodes = [],\n      role = setRole || app.currentRole;\n\n    Wb.each(choice, function(node) {\n      if (node.isLeaf())\n        nodes.push(node);\n    });\n    Wb.each(choice, function(node) {\n      if (!node.isLeaf()) {\n        node.cascadeBy(function(child) {\n          if (child.isLeaf())\n            nodes.push(child);\n        });\n      }\n    });\n    nodes = Ext.Array.unique(nodes);\n    if (nodes.length > 1) {\n      var roleText = app.roles.getRootNode().findChild('ROLE_ID', role).data.text;\n      Wb.confirm(Wb.format('确定要{0}角色\u201c{1}\u201d访问选择的 {2} 个模块吗？', checked ? '允许' : '禁止', roleText, nodes.length), doSetPerm);\n    } else doSetPerm();\n  },\n  /**\n   * 设置指定节点及其所有子节点的模块权限视图。\n   * @param {NodeInterface} [base] 指定设置该节点及其所有子节点。如果为空设置所有节点。\n   * @return {Boolean} 节点及其所有子节点是否被选中。如果节点同时存在选中和非选中节点返回null。\n   */\n  setModules: function(baseNode) {\n    var hasPerm, roles, checked, allChecked = true,\n      allUnchecked = true,\n      rolesList = app.rolesList;\n    Ext.suspendLayouts();\n    baseNode.eachChild(function(node) {\n      if (!node.data.depth)\n        return;\n      if (node.isLeaf()) {\n        roles = rolesList[node.data.path];\n        hasPerm = roles && roles[app.currentRole] == 1;\n        Wb.setChecked(node, hasPerm, app.modules);\n        if (hasPerm)\n          allUnchecked = false;\n        else\n          allChecked = false;\n      } else {\n        checked = app.setModules(node);\n        if (checked === null) {\n          allChecked = false;\n          allUnchecked = false;\n        } else if (checked)\n          allUnchecked = false;\n        else\n          allChecked = false;\n      }\n    });\n    if (allChecked)\n      checked = true;\n    else if (allUnchecked)\n      checked = false;\n    else\n      checked = null;\n    Wb.setChecked(baseNode, checked, app.modules);\n    Ext.resumeLayouts(true);\n    return checked;\n  },\n  /**\n   * 设置指定模块可访问角色的权限视图。\n   * @param {NodeInterface} node 模块节点。\n   */\n  setRoles: function(node) {\n    function isChecked(role) {\n      var roles, hasPerm, checked,\n        allUnchecked = true,\n        allChecked = true,\n        rolesList = app.rolesList;\n      node.cascadeBy(function(child) {\n        if (child.isLeaf()) {\n          roles = rolesList[child.data.path];\n          hasPerm = roles && roles[role] == 1;\n          if (hasPerm)\n            allUnchecked = false;\n          else\n            allChecked = false;\n        }\n      });\n      if (allChecked)\n        checked = true;\n      else if (allUnchecked)\n        checked = false;\n      else\n        checked = null;\n      return checked;\n    }\n    Ext.suspendLayouts();\n    app.allows.getRootNode().eachChild(function(child) {\n      Wb.setChecked(child, isChecked(child.data.ROLE_ID), app.allows);\n    });\n    Ext.resumeLayouts(true);\n  }\n});"}}],"roles":{},"title":"权限设置","iconCls":"option_icon","inframe":false,"pageLink":""}