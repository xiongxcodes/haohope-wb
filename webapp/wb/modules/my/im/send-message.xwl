{"hidden":false,"children":[{"configs":{"itemId":"module","serverScript":"var data = Wb.decode(app.get('data')),\n  currentUser = app.get('httpSession').getAttribute('sys.user'),\n  userData,\n  object = Wb.apply({\n    IM_ID: SysUtil.getId(),\n    SEND_DATE: new JavaDate(),\n    FROM_USER: currentUser,\n    \"sys.user\": currentUser\n  }, data);\n\nif (data.existsRecId) {\n  //获取已经发送的文件记录\n  Wb.apply(object, app.getData('select IM_ID,SEND_DATE from WB_IM where IM_ID={?existsRecId?}', {\n    type: 'object'\n  }));\n}\napp.set(object);\n//如果消息为设置已读标记\nif (data.action == 'setRead') {\n  app.execute('m?xwl=my/im/set-read');\n  app.send({\n    notify: true\n  });\n  return;\n}\nif (!data.existsRecId)\n  app.run('insert into WB_IM values ({?IM_ID?},{?SEND_DATE?},{?FROM_USER?},{?TO_USER?},1,null,null,{?clob.TEXT_CONTENT?},null)');\nuserData = app.getData('select USER_ID,USER_NAME,DISPLAY_NAME,1 as \"NOT_READ\" from WB_USER where USER_ID={?FROM_USER?}', {\n  type: 'object'\n});\nWb.apply(object, userData);\n//发送给im模块\nWb.send(data.TO_USER, 'sys.im', object);\n//发送给home模块\nWb.send(data.TO_USER, 'sys.home', {\n  module: 'm?xwl=my/im',\n  count: 1,\n  title: object.DISPLAY_NAME,\n  msg: object.TEXT_CONTENT\n});\n//反送给客户端已经成功送达消息\napp.send(object);"},"expanded":true,"children":[],"type":"module"}],"roles":{},"title":"发送消息","iconCls":"","inframe":false,"pageLink":""}