{"hidden":false,"children":[{"configs":{"itemId":"module","jsLinks":"[\"wb/libs/raphael/raphael.js\", \"wb/script/draw{#debugSuffix#}.js\",\"wb/script/flow{#debugSuffix#}.js\"]","cssLinks":"[\"wb/css/ide{#debugSuffix#}.css\"]"},"expanded":true,"children":[{"configs":{"layout":"border","itemId":"progressWin","width":"1000","iconCls":"arrow_branch_icon","title":"查看进度","modal":"true","maximizable":"true","height":"550"},"expanded":true,"children":[{"configs":{"itemId":"drawContainer","region":"center"},"expanded":true,"children":[],"type":"container"},{"configs":{"layout":"border","itemId":"container1","split":"true","region":"south","height":"230"},"expanded":false,"children":[{"configs":{"itemId":"hisGrid","pagingBar":"false","region":"center","iconCls":"time_icon","title":"处理历史记录"},"expanded":true,"children":[{"configs":{"itemId":"store","normalName":"hisStore","fields":"['itemId', {\n  name: 'date',\n  type: 'date',\n  dateFormat: Wb.dateFormat,\n}, 'userId', 'userName', 'userDispName', 'node', 'title', 'action']"},"expanded":false,"children":[],"type":"store"},{"configs":{"itemId":"columns"},"expanded":true,"children":[{"configs":{"itemId":"rowNumCol","xtype":"rownumberer"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"dateCol","renderer":"var iconCls;\nswitch (record.data.action) {\n  case 'pass':\n    iconCls = 'ok';\n    break;\n  case 'reject':\n    iconCls = 'minus';\n    break;\n  case 'beforeSign':\n    iconCls = 'record_edit';\n    break;\n  case 'plusSign':\n    iconCls = 'file_edit';\n    break;\n  case 'afterSign':\n    iconCls = 'table_edit';\n    break;\n  case 'turn':\n    iconCls = 'set';\n    break;\n}\nreturn Wb.getIcon(iconCls + '_icon') + Wb.dateToText(value);","dataIndex":"date","width":"170","text":"日期"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"nodeCol","dataIndex":"node","flex":"1","minWidth":"100","text":"节点名称","maxWidth":"400"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"dispNameCol","dataIndex":"userDispName","width":"130","text":"用户"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"actionCol","dataIndex":"action","width":"80","keyName":"flowAction","text":"动作类型"},"expanded":false,"children":[],"type":"column"}],"type":"array"}],"type":"grid"},{"configs":{"itemId":"usersGrid","split":"true","width":"400","pagingBar":"false","title":"处理人员","iconCls":"user_icon","region":"east"},"expanded":true,"children":[{"configs":{"itemId":"store","normalName":"usersStore","autoLoad":"false","pageSize":"-1","url":"m?xwl=my/my-flow/get-users"},"expanded":false,"children":[],"type":"store"},{"configs":{"itemId":"tools"},"expanded":true,"children":[{"configs":{"itemId":"refreshBtn","iconCls":"refresh_icon","tooltype":"refresh"},"expanded":false,"children":[],"type":"item","events":{"click":"app.usersStore.reload();"}}],"type":"array"},{"configs":{"itemId":"columns"},"expanded":true,"children":[{"configs":{"itemId":"rowNumCol","xtype":"rownumberer"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"userNameCol","renderer":"var iconCls, tip, isCc = record.data.IS_CC,\n  needProcess = record.data.NEED_PROCESS;\nif (needProcess == 1) {\n  if (isCc) {\n    iconCls = 'preview_icon';\n    tip = '待查看';\n  } else {\n    iconCls = 'file_edit_icon';\n    tip = '待处理';\n  }\n} else {\n  iconCls = 'ok_icon';\n  if (isCc) {\n    tip = '已查看';\n  } else {\n    tip = '已处理';\n  }\n}\nreturn Wb.getIcon(iconCls, tip) + value;","dataIndex":"USER_NAME","width":"140","text":"用户名称"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"dispNameCol","dataIndex":"DISPLAY_NAME","flex":"1","text":"显示名称"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"processedCol","renderer":"var isCc = record.data.IS_CC;\nif (value == 1)\n  return isCc ? '待查看' : '待处理';\nelse\n  return isCc ? '已查看' : '已处理';","dataIndex":"NEED_PROCESS","width":"60","text":"状态"},"expanded":false,"children":[],"type":"column"}],"type":"array"}],"type":"grid"}],"type":"container"}],"type":"window","events":{"hide":"app.usersStore.removeAll();"}},{"configs":{"layout":"fit","itemId":"viewport1"},"expanded":true,"children":[{"configs":{"itemId":"grid1","syncStateId":"sys.my-flow","multiSelect":"true"},"expanded":true,"children":[{"configs":{"itemId":"store","remoteSort":"true","normalName":"gridStore","sorters":"{property:'LAST_MODIFY_DATE',direction:'DESC'}","url":"m?xwl=my/my-flow/select"},"expanded":false,"children":[],"type":"store"},{"configs":{"itemId":"viewConfig","getRowClass":"var cls = [];\nif (record.data.MY_ID == record.data.START_USER_ID)\n  cls.push('wb_highlight_row');\nif (record.data.NEED_PROCESS && record.data.STATUS == 1)\n  cls.push('wb_bold_row');\nreturn cls.join(' ');"},"expanded":false,"children":[],"type":"tableview"},{"configs":{"itemId":"tbar","enableOverflow":"true","normalName":"mainBar"},"expanded":false,"children":[{"configs":{"itemId":"beginDateLbl","xtype":"tbtext","text":"显示从："},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"beginDate","width":"110"},"expanded":true,"children":[],"type":"date","events":{"select":"app.loadData();"}},{"configs":{"itemId":"toDateLbl","xtype":"tbtext","text":"到："},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"endDate","width":"110"},"expanded":true,"children":[],"type":"date","events":{"select":"app.loadData();"}},{"configs":{"itemId":"prevMonthBtn","tooltip":"转到上个月","text":"上月","iconCls":"left_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.addMonth(-1);"}},{"configs":{"itemId":"nextMonthBtn","tooltip":"转到下个月","text":"下月","iconCls":"right_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.addMonth(1);"}},{"configs":{"itemId":"item1","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"searchTitleCombo","onTriggerClick":"app.loadData();","emptyText":"标题","triggerCls":"x-form-search-trigger","width":"150","displayField":"TITLE"},"expanded":false,"children":[{"configs":{"itemId":"store","url":"m?xwl=my/my-flow/search-title"},"expanded":false,"children":[],"type":"store"}],"type":"combo","events":{"select":"app.loadData();"}},{"configs":{"itemId":"resetSearch","tooltip":"重置搜索结果","text":"重置","iconCls":"undo_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"Wb.reset(app.mainBar);\napp.loadData();"}},{"configs":{"itemId":"viewUnDoneBtn","tooltip":"搜索所有待办项/全部项","text":"待办","iconCls":"view_icon","enableToggle":"true"},"expanded":false,"children":[],"type":"item","events":{"toggle":"app.loadData();"}},{"configs":{"itemId":"item2","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"processFlowBtn","tooltip":"处理选择的流程","text":"处理","iconCls":"write_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.processFlow();"}},{"configs":{"itemId":"viewFlowBtn","tooltip":"查看选择的流程","text":"查看","iconCls":"seek_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.viewFlow();"}},{"configs":{"itemId":"progressBtn","tooltip":"查看选择的流程进度","text":"进度","iconCls":"arrow_branch_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.viewProgress();"}},{"configs":{"itemId":"statusMenu","text":"状态","iconCls":"property_icon"},"expanded":true,"children":[{"configs":{"tagConfigs":"{\n  status: 3\n}","itemId":"pauseBtn","text":"暂停","iconCls":"pause_icon"},"expanded":false,"children":[],"type":"item"},{"configs":{"tagConfigs":"{\n  status: 1\n}","itemId":"resumeBtn","text":"恢复","iconCls":"resume_icon"},"expanded":false,"children":[],"type":"item"},{"configs":{"tagConfigs":"{\n  status: 4\n}","itemId":"stopBtn","text":"中止","iconCls":"stop_icon"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"removeBtn","bindModule":"m?xwl=my/my-flow/remove","text":"删除","iconCls":"delete_icon"},"expanded":false,"children":[],"type":"item"}],"type":"item","events":{"menuclick":"app.setStatus(item);"}}],"type":"toolbar","events":{"afterrender":"toolbar.el.on('keydown', function(e) {\n  if (e.getKey() == e.ENTER)\n    app.loadData();\n});"}},{"configs":{"itemId":"columns"},"expanded":true,"children":[{"configs":{"itemId":"rowNumCol","xtype":"rownumberer"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"lastDateCol","renderer":"var icon, color, hint, data = record.data;\nswitch (data.STATUS) {\n  case 1:\n    if (data.IS_CC) {\n      icon = 'record';\n      hint = '抄送给我的流程';\n    } else {\n      icon = 'list';\n      hint = '正常处理中的流程';\n    }\n    break;\n  case 2:\n    icon = 'ok';\n    hint = '流程已经处理完成';\n    break;\n  case 3:\n    icon = 'pause';\n    hint = '流程已经暂停';\n    break;\n  case 4:\n    icon = 'stop';\n    hint = '流程已经中止';\n    break;\n}\nreturn Wb.getIcon(icon + '_icon', hint) + Wb.dateToText(value);","dataIndex":"LAST_MODIFY_DATE","width":"170","text":"最后处理时间"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"titleCol","dataIndex":"TITLE","flex":"1","minWidth":"100","text":"标题","maxWidth":"500"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"flowNameCol","dataIndex":"FLOW_NAME","width":"170","text":"流程名称"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"startDateCol","dataIndex":"START_DATE","width":"130","text":"发起时间"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"startUserCol","dataIndex":"START_USER_DISP_NAME","width":"130","text":"发起人"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"lastUsersCol","dataIndex":"LAST_USER_DISP_NAME","width":"130","text":"最后处理人"},"expanded":false,"children":[],"type":"column"},{"configs":{"itemId":"statusCol","dataIndex":"STATUS","width":"60","keyName":"flowStatus","text":"状态"},"expanded":false,"children":[],"type":"column"}],"type":"array"}],"type":"grid","events":{"itemdblclick":"if (record.data.STATUS == 1 && record.data.NEED_PROCESS && !record.data.IS_CC)\n  app.processFlow();\nelse\n  app.viewFlow();"}}],"type":"viewport","events":{"afterrender":"app.afterRender();"}}],"type":"module","events":{"initialize":"Wb.apply(app, {\n  loadData: function() {\n    app.gridStore.load({\n      out: app.mainBar,\n      params: {\n        viewUnDone: app.viewUnDoneBtn.pressed\n      }\n    });\n  },\n  afterRender: function() {\n    app.loadData();\n  },\n  addMonth: function(val) {\n    var date = Ext.Date.add(app.endDate.getValue() || new Date(), Ext.Date.MONTH, val);\n    app.beginDate.setValue(Ext.Date.add(date, Ext.Date.MONTH, -1));\n    app.endDate.setValue(date);\n    app.loadData();\n  },\n  viewProgress: function() {\n    var flowId, rec = app.grid1.getSelection();\n    if (rec.length != 1) {\n      Wb.warn('请选择 1 个需要查看的流程。');\n      return;\n    }\n    rec = rec[0];\n    flowId = rec.data.FLOW_ID;\n    Wb.request({\n      url: 'm?xwl=my/my-flow/get-flow',\n      params: {\n        FLOW_ID: flowId\n      },\n      success: function(resp) {\n        var drawComp, node, lastNode, index, path, data = Wb.decode(resp.responseText);\n        app.progressWin.show();\n        app.usersStore.load({\n          params: {\n            FLOW_ID: flowId\n          }\n        });\n        Wb.setTitle(app.progressWin, rec.data.FLOW_NAME);\n        app.drawContainer.removeAll();\n        drawComp = app.drawContainer.add({\n          xtype: 'drawcomp',\n          width: 5000,\n          height: 5000,\n          disableDesign: true,\n          autoScroll: data.flow.autoScroll,\n          isFlow: true,\n          bodyStyle: 'background-image:none;background-color:' + data.flow.backColor + ';'\n        });\n        //移除加签的节点\n        index = data.nodes.length;\n        Wb.each(data.nodes, function(node) {\n          index--;\n          if (node.x === undefined)\n            data.nodes.splice(index, 1);\n        }, true);\n        //恢复原始连接\n        data.links = Wb.decode(data.rawLinks);\n        drawComp.load(data);\n        app.hisStore.loadData(data.history);\n        //所有节点置灰色\n        Wb.each(drawComp.getItems(), function(item) {\n          if (item.isNode) {\n            item.rect.attr({\n              fill: '#ccc'\n            });\n            item.label.attr({\n              fill: '#000'\n            });\n          } else {\n            item.attr({\n              stroke: '#ccc'\n            });\n          }\n        });\n        //已处理节点高亮\n        Wb.each(data.history, function(item) {\n          node = drawComp.findItem(item.node);\n          if (node) {\n            node.rect.attr({\n              fill: '#337ab7'\n            });\n            node.label.attr({\n              fill: '#fff'\n            });\n          }\n          if (lastNode) {\n            path = drawComp.findPath(lastNode, item.node);\n            if (path)\n              path.attr({\n                stroke: '#337ab7'\n              });\n          }\n          lastNode = item.node;\n        });\n        //将要处理节点红色显示\n        node = drawComp.findItem(data.activeNode);\n        if (node) {\n          node.rect.attr({\n            fill: '#e10601'\n          });\n          node.label.attr({\n            fill: '#fff'\n          });\n        }\n        //结束的连接线\n        if (data.activeNode == '结束') {\n          path = drawComp.findPath(lastNode, data.activeNode);\n          if (path)\n            path.attr({\n              stroke: '#337ab7'\n            });\n        }\n      }\n    });\n  },\n  viewFlow: function() {\n    var config, isCc, rec = app.grid1.getSelection();\n    if (rec.length != 1) {\n      Wb.warn('请选择 1 个需要查看的流程。');\n      return;\n    }\n    rec = rec[0];\n    isCc = rec.data.IS_CC;\n    config = {\n      flowId: rec.data.FLOW_ID,\n      nodeName: rec.data.NODE_NAME,\n      params: {\n        _fromView: 1 //设置由查看按钮触发标记\n      }\n    };\n    if (rec.data.NEED_PROCESS && isCc) {\n      config.params._viewDone = 1;\n      config.onOpen = function() {\n        Wb.update(rec, {\n          NEED_PROCESS: 0\n        });\n      };\n    }\n    Flow.viewFlow(config);\n  },\n  processFlow: function() {\n    var data, rec = app.grid1.getSelection();\n    if (rec.length != 1) {\n      Wb.warn('请选择 1 个需要处理的流程。');\n      return;\n    }\n    rec = rec[0];\n    switch (rec.data.STATUS) {\n      case 2:\n        Wb.warn('该流程已经结束。');\n        return;\n      case 3:\n        Wb.warn('该流程已经暂停。');\n        return;\n      case 4:\n        Wb.warn('该流程已经终止。');\n        return;\n    }\n    if (!rec.data.NEED_PROCESS || rec.data.IS_CC) {\n      Wb.warn('当前节点由其他人员处理。');\n      return;\n    }\n    data = rec.data;\n    Flow.openFlow({\n      flowId: data.FLOW_ID,\n      nodeName: data.NODE_NAME,\n      onAction: function(respObject) {\n        Wb.update(rec, respObject);\n      }\n    });\n  },\n  doAction: function(item) {\n    var actionName = item.itemId.slice(0, -3),\n      title = item.text,\n      iconCls = item.iconCls,\n      rec = app.grid1.getSelection()[0],\n      data = rec.data;\n\n    Flow[actionName]({\n      flowId: data.FLOW_ID,\n      title: title,\n      iconCls: iconCls,\n      nodeName: data.NODE_NAME,\n      actionName: actionName,\n      success: function(respObject) {\n        Wb.update(rec, respObject);\n      }\n    });\n  },\n  setStatus: function(btn) {\n    var verb = btn.text,\n      action = btn.itemId.slice(0, -3),\n      status = btn.status,\n      recs = app.grid1.getSelection(),\n      notMineRec, stopRec, finishRec;\n\n    if (action != 'remove') {\n      Wb.each(recs, function(rec) {\n        if (rec.data.START_USER_ID != rec.data.MY_ID) {\n          notMineRec = rec;\n          return false;\n        }\n        if (rec.data.STATUS == 4) {\n          stopRec = rec;\n          return false;\n        }\n        if (rec.data.STATUS == 2) {\n          finishRec = rec;\n          return false;\n        }\n      });\n      if (notMineRec) {\n        Wb.warn('您不是流程\u201c' + notMineRec.data.FLOW_NAME + '\u201d的发起人，不能设置状态。');\n        return;\n      }\n      if (stopRec) {\n        Wb.warn('流程\u201c' + stopRec.data.FLOW_NAME + '\u201d已经终止。');\n        return;\n      }\n      if (finishRec) {\n        Wb.warn('流程\u201c' + finishRec.data.FLOW_NAME + '\u201d已经完成。');\n        return;\n      }\n    }\n\n    function doSet() {\n      Wb.request({\n        url: 'm?xwl=my/my-flow/' + action,\n        out: app.grid1,\n        success: function(resp) {\n          if (action == 'remove') {\n            Wb.remove(app.grid1);\n          } else {\n            Wb.each(recs, function(rec) {\n              rec.set('STATUS', status);\n            });\n            app.gridStore.commitChanges();\n          }\n        }\n      });\n    }\n    Wb.confirmDo(recs, doSet, 'FLOW_NAME', verb);\n  }\n});"}}],"roles":{},"title":"我的工作","iconCls":"table_icon","inframe":false,"pageLink":""}