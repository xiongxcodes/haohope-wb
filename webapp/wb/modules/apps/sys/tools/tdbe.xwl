{"hidden":false,"children":[{"configs":{"itemId":"module"},"expanded":true,"children":[{"configs":{"itemId":"gridPage","createInstance":"false","editable":"true","rowNumber":"true","loadColumns":"none"},"expanded":true,"children":[{"configs":{"itemId":"store","normalName":"sqlStore","clearOnPageLoad":"false","url":"m?xwl=sys/tool/db/execute"},"expanded":false,"children":[],"type":"tstore","events":{"success":"if (!store.columnsLoaded) {\n  var cols = Wb.getColumns(store);\n  Wb.each(cols, function(col) {\n    if (col.width)\n      col.width = Math.round(col.width * 1.2);\n    else if (col.flex)\n      col.width = 200;\n    if (col.editor) {\n      switch (col.category) {\n        case 'timestamp':\n          col.editor.xtype = 'datetimefield';\n          col.editor.type = 'auto';\n          col.renderer = app.dateRenderer;\n          break;\n        case 'date':\n          col.editor.xtype = 'datetimefield';\n          col.editor.type = 'date';\n          col.editor.format = 'Y-m-d';\n          col.renderer = app.dateRenderer;\n          break;\n        case 'time':\n          col.editor.xtype = 'datetimefield';\n          col.editor.type = 'time';\n          col.editor.format = 'H:i:s';\n          col.renderer = app.dateRenderer;\n          break;\n      }\n    }\n  });\n  app.gridPage.updateColumns(cols);\n  store.columnsLoaded = true;\n}"}},{"configs":{"itemId":"titleBar"},"expanded":true,"children":[{"configs":{"itemId":"back","glyph":"f053","align":"left"},"expanded":false,"children":[],"type":"tbutton","events":{"tap":"//app.gridPage.store.destroy(); store默认随容器自动destroy，由属性destroyByOwer指定\napp.gridPage.destroy();\nif (app.fromSql)\n  app.viewport1.setActiveItem(app.sqlPage);"}},{"configs":{"itemId":"menu","glyph":"f0c9","align":"right"},"expanded":false,"children":[],"type":"tbutton","events":{"tap":"app.gridMenu.showBy(button);"}}],"type":"ttitlebar"}],"type":"tgrid","events":{"tapcancel":"sheet.hide();","painted":"if (!app.fromSql) {\n  var me = this;\n  me.downloadBlob = app.downloadBlob;\n  me.uploadBlob = app.uploadBlob;\n  me.removeBlob = app.removeBlob;\n}","tapdelete":"Wb.confirm('确定要删除该记录吗？', function() {\n  var params = {\n    table: Wb.addPrefix(app.schema, app.table),\n    jndi: app.jndi,\n    destroy: Wb.getData([record], true)\n  };\n  Wb.request({\n    url: 'm?xwl=sys/tool/db/save',\n    params: params,\n    success: function(resp) {\n      grid._store.remove(record);\n      sheet.hide();\n    }\n  });\n});","tapok":"if (!Wb.verify(form))\n  return;\nvar values, isAdd, params = {\n  table: Wb.addPrefix(app.schema, app.table),\n  jndi: app.jndi\n};\nvalues = Wb.getValue(form);\nif (record) {\n  //修改\n  Ext.applyIf(values, Wb.getData(record, true));\n  //删除filefield字段，因为在form中提交实际文件数据\n  Wb.each(form.query('filefield'), function(field) {\n    delete values[field.itemId];\n  });\n  params.update = [values];\n} else {\n  //添加\n  params.create = [values];\n}\nvalues = Wb.getValue(form, null, true); //重新获取包含文件名称的values，用于更新记录\nWb.upload({\n  url: 'm?xwl=sys/tool/db/save',\n  form: form,\n  params: params,\n  success: function(resp) {\n    if (record)\n      record.set(values);\n    else {\n      isAdd = true;\n      record = grid.store.add(values)[0];\n    }\n    record.commit();\n    sheet.hide();\n    if (isAdd)\n      grid.scrollToRecord(record);\n  }\n});"}},{"configs":{"layout":"fit","itemId":"gridMenu","hidden":"true","hideOnMaskTap":"true","top":"0","left":"0","width":"180","modal":"true","height":"240"},"expanded":true,"children":[{"configs":{"padding":"8","itemId":"dataview1","scrollable":"false","itemTpl":"@Wb.menuItem"},"expanded":true,"children":[{"configs":{"itemId":"store","data":"/*基于演示目的使用dataview生成菜单，可以直接配置panel的menu属性生成菜单，见tfile示例*/\n[{\n  text: '添加记录',\n  glyph: 'f067',\n  handler: app.addRecord\n}, {\n  text: '过滤',\n  glyph: 'f0b0',\n  handler: app.setFilter\n}, {\n  text: '导入 GZ 文件',\n  glyph: 'f0ab',\n  handler: app.importGZ\n}, {\n  text: '导出 GZ 文件',\n  forSQL: true,\n  glyph: 'f0aa',\n  handler: app.exportGZ\n}, {\n  text: '导出 Excel 文件',\n  forSQL: true,\n  glyph: 'f1c3',\n  handler: app.exportExcel\n}, {\n  text: '导出文本文件',\n  forSQL: true,\n  glyph: 'f016',\n  handler: app.exportText\n}, {\n  text: '属性',\n  forSQL: true,\n  glyph: 'f05a',\n  handler: app.viewProperties\n}, {\n  text: '刷新',\n  forSQL: true,\n  glyph: 'f021',\n  handler: app.refreshGrid\n}]","fields":"['text', 'glyph', 'handler', 'forSQL']"},"expanded":false,"children":[],"type":"tstore"}],"type":"tdataview","events":{"itemtap":"app.gridMenu.hide();\nrecord.get('handler')();"}}],"type":"tpanel","events":{"show":"if (app.fromSql) {\n  app.dataview1.store.filter('forSQL', true);\n  app.gridMenu.setHeight(200);\n} else {\n  app.dataview1.store.clearFilter();\n  app.gridMenu.setHeight(320);\n}"}},{"configs":{"layout":"card","itemId":"viewport1","appImage":"wb/images/icon/db.png"},"expanded":true,"children":[{"configs":{"itemId":"tableList","title":"数据库"},"expanded":true,"children":[{"configs":{"itemId":"store","fields":"['text', 'jndi', 'type', 'schema', 'table']","url":"m?xwl=dev/datainfo/SQL/dbe/get-tree"},"expanded":false,"children":[],"type":"ttreestore","events":{"beforeload":"operation._params = operation._node.data;"}},{"configs":{"itemId":"toolbar","docked":"top"},"expanded":true,"children":[{"configs":{"itemId":"sqlBtn","text":"SQL","align":"right"},"expanded":false,"children":[],"type":"tbutton","events":{"tap":"app.viewport1.setActiveItem(app.sqlPage);"}}],"type":"ttitlebar"}],"type":"tnlist","events":{"listchange":"app.sqlBtn.setHidden(listitem._store._node.data.depth === 0); //根节点隐藏","itemtap":"if (record.isLeaf()) {\n  app.table = record.data.table;\n  app.schema = record.data.schema;\n  app.runSql(app.jndi, 'select * from ' + Wb.addPrefix(app.schema, app.table), app.table, false);\n} else\n  app.jndi = record.data.jndi;"}},{"configs":{"layout":"fit","itemId":"sqlPage"},"expanded":true,"children":[{"configs":{"itemId":"titlebar1","title":"SQL","docked":"top"},"expanded":true,"children":[{"configs":{"itemId":"back","glyph":"f053","text":"返回","align":"left"},"expanded":false,"children":[],"type":"tbutton","events":{"tap":"app.viewport1.setActiveItem(app.tableList);"}},{"configs":{"itemId":"run","glyph":"f04b","ui":"action","text":"运行","align":"right"},"expanded":false,"children":[],"type":"tbutton","events":{"tap":"app.runSql(app.jndi, app.sqlText.getValue(), 'SQL', true);"}}],"type":"ttitlebar"},{"configs":{"itemId":"sqlText","xtype":"textareafield"},"expanded":false,"children":[],"type":"ttext"}],"type":"tcontainer","events":{"resize":"app.sqlText.setHeight(app.sqlPage.innerElement.getHeight());"}},{"configs":{"itemId":"uploadPage"},"expanded":true,"children":[{"configs":{"itemId":"titlebar1","title":"导入","docked":"top"},"expanded":true,"children":[{"configs":{"itemId":"back","glyph":"f053","text":"返回","align":"left"},"expanded":false,"children":[],"type":"tbutton","events":{"tap":"app.viewport1.setActiveItem(app.gridPage);"}},{"configs":{"itemId":"import","glyph":"f0ab","ui":"action","text":"导入","align":"right"},"expanded":false,"children":[],"type":"tbutton","events":{"tap":"app.doUpload();"}}],"type":"ttitlebar"},{"configs":{"itemId":"file","label":"文件","required":"true"},"expanded":false,"children":[],"type":"tfile"},{"configs":{"itemId":"trans","label":"使用事务","value":"true"},"expanded":false,"children":[],"type":"ttoggle"}],"type":"tform"},{"configs":{"itemId":"propertyPage","title":"属性","rowNumber":"true"},"expanded":true,"children":[{"configs":{"itemId":"store","normalName":"propertyStore","fields":"['dataIndex', 'metaType', 'metaSize', 'metaScale', 'metaRequired']"},"expanded":false,"children":[],"type":"tstore"},{"configs":{"itemId":"titleBar"},"expanded":true,"children":[{"configs":{"itemId":"back","glyph":"f053","text":"返回","align":"left"},"expanded":false,"children":[],"type":"tbutton","events":{"tap":"app.viewport1.setActiveItem(app.gridPage);"}}],"type":"ttitlebar"},{"configs":{"itemId":"columns"},"expanded":true,"children":[{"configs":{"itemId":"numCol","xtype":"rownumberer","width":"30"},"expanded":false,"children":[],"type":"tcolumn"},{"configs":{"itemId":"nameCol","renderer":"if (record.get('metaRequired'))\n  return '<b>' + value + '<\/b>';\nelse return value;","dataIndex":"dataIndex","width":"230","text":"字段名称"},"expanded":false,"children":[],"type":"tcolumn"},{"configs":{"itemId":"typeCol","dataIndex":"metaType","width":"120","text":"类型"},"expanded":false,"children":[],"type":"tcolumn"},{"configs":{"itemId":"sizeCol","dataIndex":"metaSize","width":"120","text":"大小","align":"right"},"expanded":false,"children":[],"type":"tcolumn"},{"configs":{"itemId":"scaleCol","dataIndex":"metaScale","width":"60","text":"精度","align":"right"},"expanded":false,"children":[],"type":"tcolumn"},{"configs":{"itemId":"requiredCol","xtype":"booleancolumn","dataIndex":"metaRequired","trueText":"是","width":"60","text":"必填","falseText":"否"},"expanded":false,"children":[],"type":"tcolumn"}],"type":"array"}],"type":"tgrid"},{"configs":{"layout":"fit","itemId":"filterPage"},"expanded":true,"children":[{"configs":{"itemId":"titlebar1","title":"过滤","docked":"top"},"expanded":true,"children":[{"configs":{"itemId":"back","glyph":"f053","text":"返回","align":"left"},"expanded":false,"children":[],"type":"tbutton","events":{"tap":"app.viewport1.setActiveItem(app.gridPage);"}},{"configs":{"itemId":"ok","glyph":"f00c","ui":"action","text":"确定","align":"right"},"expanded":false,"children":[],"type":"tbutton","events":{"tap":"var whereSql = app.filterText.getValue();\nif (whereSql)\n  whereSql = ' where ' + whereSql;\napp.sqlStore.load({\n  params: {\n    jndi: app.jndi,\n    sql: 'select * from ' + Wb.addPrefix(app.schema, app.table) + whereSql\n  }\n});\napp.viewport1.setActiveItem(app.gridPage);"}}],"type":"ttitlebar"},{"configs":{"itemId":"filterText","xtype":"textareafield"},"expanded":false,"children":[],"type":"ttext"}],"type":"tcontainer","events":{"resize":"app.filterText.setHeight(app.filterPage.innerElement.getHeight());"}}],"type":"tviewport"}],"type":"module","events":{"initialize":"Wb.apply(app, {\n  /** 运行 SQL 语句 */\n  runSql: function(jndi, sql, title, fromSql) {\n    app.fromSql = fromSql;\n    app.currentSql = sql;\n    app.gridPage = app.viewport1.add(app._gridPage);\n    app.gridPage.setTitle(title);\n    if (fromSql)\n      app.gridPage.setEditButtons(false);\n    app.sqlStore.load({\n      params: {\n        jndi: jndi,\n        sql: sql\n      },\n      callback: function(a, b, succ) {\n        if (succ)\n          app.viewport1.setActiveItem(app.gridPage);\n      }\n    });\n  },\n  /** 添加记录 */\n  addRecord: function() {\n    app.gridPage.addRecord();\n  },\n  /** 刷新表格 */\n  refreshGrid: function() {\n    var store = app.gridPage.store;\n    store.setClearOnPageLoad(true);\n    store.loadPage(1);\n    store.setClearOnPageLoad(false);\n  },\n  /** 导出 GZ */\n  exportGZ: function() {\n    Wb.download('m?xwl=sys/tool/db/export', {\n      sql: app.currentSql,\n      jndi: app.jndi,\n      filename: app.fromSql ? 'data.gz' : app.table + '.gz'\n    });\n  },\n  /** 导入 GZ */\n  importGZ: function() {\n    app.doUpload = app.doImportGZ;\n    app.trans.setHidden(false);\n    app.file.setAccept('application/gzip');\n    app.viewport1.setActiveItem(app.uploadPage);\n  },\n  /** 导入数据至指定表 */\n  doImportGZ: function() {\n    if (!Wb.verify(app.uploadPage))\n      return;\n    Wb.upload({\n      form: app.uploadPage,\n      url: 'm?xwl=sys/tool/db/import',\n      params: {\n        table: Wb.addPrefix(app.schema, app.table),\n        jndi: app.jndi\n      },\n      success: function() {\n        app.file.reset();\n        app.viewport1.setActiveItem(app.gridPage);\n        app.gridPage.store.reload();\n      }\n    });\n  },\n  /** 导出 Excel */\n  exportExcel: function() {\n    app.gridPage.exportFilename = app.fromSql ? 'data' : app.table;\n    Wb.exportData(app.gridPage, 'excel', true);\n  },\n  /** 导出 Text */\n  exportText: function() {\n    app.gridPage.exportFilename = app.fromSql ? 'data' : app.table;\n    Wb.exportData(app.gridPage, 'text', true);\n  },\n  /** 查看属性 */\n  viewProperties: function() {\n    app.viewport1.setActiveItem(app.propertyPage);\n    if (app.sqlStore._proxy._reader.rawData) {\n      var cols = app.sqlStore._proxy._reader.rawData.columns,\n        store = app.propertyStore;\n      store.setData(cols);\n      store.removeAt(0);\n    } else\n      Wb.warn('表格无数据。');\n  },\n  /** 设置过滤条件 */\n  setFilter: function() {\n    app.viewport1.setActiveItem(app.filterPage);\n  },\n  /** 下载二进制字段 */\n  downloadBlob: function(fieldName, rowIndex) {\n    var grid = this;\n    Wb.download('m?xwl=sys/tool/db/download-blob', Ext.apply({\n      __jndi: app.jndi,\n      __tableName: Wb.addPrefix(app.schema, app.table),\n      __fieldName: fieldName\n    }, Wb.getData(grid.store.getAt(rowIndex), true)));\n  },\n  /** 上传二进制字段 */\n  uploadBlob: function(fieldName, rowIndex) {\n    app.uploadFieldName = fieldName;\n    app.uploadRowIndex = rowIndex;\n    app.uploadGrid = this;\n    app.doUpload = app.doUploadBlob;\n    app.trans.setHidden(true);\n    app.file.setAccept('');\n    app.viewport1.setActiveItem(app.uploadPage);\n  },\n  /** 执行二进制字段上传方法 */\n  doUploadBlob: function() {\n    var grid = app.uploadGrid,\n      fieldName = app.uploadFieldName,\n      rowIndex = app.uploadRowIndex,\n      rec = grid.store.getAt(rowIndex);\n\n    if (!Wb.verify(app.uploadPage))\n      return;\n    Wb.upload({\n      form: app.uploadPage,\n      url: 'm?xwl=sys/tool/db/upload-blob',\n      params: Ext.apply({\n        __jndi: app.jndi,\n        __tableName: Wb.addPrefix(app.schema, app.table),\n        __fieldName: fieldName\n      }, Wb.getData(rec, true)),\n      success: function() {\n        app.file.reset();\n        app.viewport1.setActiveItem(app.gridPage);\n        rec.set(fieldName, 'blob');\n        rec.commit();\n      }\n    });\n  },\n  /** 删除二进制字段 */\n  removeBlob: function(fieldName, rowIndex) {\n    var grid = this,\n      rec = grid.store.getAt(rowIndex);\n    Wb.confirm('确定要删除该记录字段 \u201c' + fieldName + '\u201d 的内容吗？', function() {\n      Wb.request({\n        url: 'm?xwl=sys/tool/db/clear-blob',\n        params: Ext.apply({\n          __jndi: app.jndi,\n          __tableName: Wb.addPrefix(app.schema, app.table),\n          __fieldName: fieldName\n        }, Wb.getData(rec, true)),\n        success: function(resp) {\n          rec.set(fieldName, '');\n          rec.commit();\n        }\n      });\n    });\n  },\n  /** 日期值显示方法 */\n  dateRenderer: function(date) {\n    var str, category = this.initialConfig.category;\n    if (category == 'time')\n      return Wb.format(date, 'H:i:s');\n    else if (category == 'date')\n      return Wb.format(date, 'Y-m-d');\n    else {\n      //timestamp\n      str = Wb.dateToStr(date);\n      if (Ext.String.endsWith(str, '00:00:00.000'))\n        return str.substring(0, 10);\n      else if (Ext.String.endsWith(str, '.000'))\n        return str.substring(0, 19);\n      else return str;\n    }\n  }\n});"}}],"roles":{},"title":"数据库浏览器","iconCls":"seek_icon","inframe":true,"pageLink":""}