{"hidden":false,"children":[{"configs":{"itemId":"module","description":"即时通讯用到的WebSocket功能由Chrome,FF, IE10+和其他现代浏览器支持\nIE9-版本不支持WebSocket功能"},"expanded":true,"children":[{"configs":{"itemId":"messageStore","url":"m?xwl=my/im/select-message"},"expanded":false,"children":[],"type":"store"},{"configs":{"itemId":"messageSocket","name":"sys.im","url":"m?xwl=my/im/send-message"},"expanded":false,"children":[],"type":"socket","events":{"onopen":"app.disableDialog(false);","success":"var el, rec, data = Wb.decode(data);\nif (feedback) {\n  //如果是通知消息直接返回\n  if (data.notify)\n    return;\n  //如果是反馈消息，根据id号删除\"发送中\"的提示图标\n  el = Ext.fly(data.msgId);\n  if (el)\n    el.remove();\n} else {\n  if (!data.FROM_SYS && data.TO_USER == data.FROM_USER) {\n    //自己给自己主动发送的消息不显示\n  } else if (app.currentUserId == data.FROM_USER) { //当前用户接收到消息直接显示\n    app.addDate(Wb.strToDate(data.SEND_DATE), false);\n    app.addMessage(data.TEXT_CONTENT, false, false);\n    app.toBottom();\n    data.NOT_READ = 0;\n    app.addTopHisUser(data);\n    //发送消息已读信息给后台以更新数据库\n    socket.send({\n      action: 'setRead',\n      FROM_USER: data.USER_ID\n    });\n  } else {\n    //其他用户徽章标记加1\n    rec = app.hisUserStore.findExactRec('USER_ID', data.USER_ID);\n    if (rec)\n      data.NOT_READ = rec.data.NOT_READ + 1;\n    else data.NOT_READ = 1;\n    app.addTopHisUser(data);\n  }\n}","onclose":"//关闭模块将销毁app内所有控件，因为关闭是异步触发的事件，所以需要加以判断\nif (app.disableDialog)\n  app.disableDialog(true);"}},{"configs":{"layout":"border","itemId":"viewport1"},"expanded":true,"children":[{"configs":{"layout":"border","border":"false","itemId":"userPanel","split":"true","width":"250","weight":"90","bodyStyle":"background:white;","region":"west"},"expanded":true,"children":[{"configs":{"itemId":"hisUserView","badgeFieldName":"NOT_READ","tplDisplay":"{DISPLAY_NAME} ({USER_NAME})","region":"center","tplIcon":"wb/images/user.png"},"expanded":true,"children":[{"configs":{"itemId":"store","normalName":"hisUserStore","autoLoad":"true","pageSize":"-1","url":"m?xwl=my/im/select-his-users"},"expanded":false,"children":[],"type":"store"}],"type":"dataview","events":{"itemclick":"app.loadDialog(record.data);"}},{"configs":{"layout":"fit","itemId":"panel1","split":"true","region":"south","height":"260"},"expanded":true,"children":[{"configs":{"itemId":"allUserView","tplDisplay":"{DISPLAY_NAME} ({USER_NAME})","tplIcon":"wb/images/user.png"},"expanded":false,"children":[{"configs":{"itemId":"store","normalName":"allUserStore","autoLoad":"true","pageSize":"-1","url":"m?xwl=my/im/select-all-users"},"expanded":false,"children":[],"type":"store","events":{"beforeload":"operation.params.searchUserText = app.searchUserText.getValue();"}}],"type":"dataview","events":{"itemclick":"app.loadDialog(record.data);"}},{"configs":{"isConfig":"true","itemId":"tbar"},"expanded":true,"children":[{"configs":{"itemId":"searchUserText","emptyText":"@Str.search","flex":"1"},"expanded":false,"children":[],"type":"text","events":{"change":"app.allUserStore.load();"}},{"configs":{"itemId":"resetBtn","tooltip":"@Str.resetSearch","iconCls":"undo_icon"},"expanded":false,"children":[],"type":"item","events":{"click":"app.searchUserText.reset();"}}],"type":"toolbar"}],"type":"panel"}],"type":"panel"},{"configs":{"itemId":"dialogComp","bodyStyle":"background-color:#f3f3f3;","region":"center","autoScroll":"true"},"expanded":true,"children":[],"type":"panel","events":{"afterrender":"panel.mon(panel.body, 'scroll', function(e) {\n  if (panel.body.dom.scrollTop === 0 && app.onDialogScroll && app.lastRecId) {\n    app.onDialogScroll();\n  }\n});\npanel.mon(panel.body, 'click', function(e) {\n  var src = e.target.src;\n  if (e.target.tagName == 'IMG' && e.target.src) {\n    Wb.run({\n      url: 'image-viewer',\n      single: true,\n      success: function() {\n        this.show(src);\n      }\n    });\n  }\n});"}},{"configs":{"layout":"fit","itemId":"msgPanel","split":"true","buttonAlign":"right","disabled":"true","region":"south"},"expanded":true,"children":[{"configs":{"isConfig":"true","itemId":"tbar"},"expanded":true,"children":[{"configs":{"itemId":"spaceBtn","xtype":"tbspacer","width":"10"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"sendFileBtn","glyph":"f07c","tooltip":"@str.sendFile"},"expanded":true,"children":[],"type":"item","events":{"click":"app.file1.fileInputEl.dom.click();"}},{"configs":{"itemId":"acceptEnterbtn","glyph":"f190","tooltip":"@str.acceptEnter","enableToggle":"true"},"expanded":true,"children":[],"type":"item"},{"configs":{"itemId":"spItem","text":"-"},"expanded":false,"children":[],"type":"item"},{"configs":{"itemId":"searchCombo","onTriggerClick":"app.loadDialog(app.currentUserData, true, this.getValue());","emptyText":"@Str.search","triggerCls":"x-form-search-trigger","width":"180","enterKeyTriggerClick":"true"},"expanded":false,"children":[],"type":"combo"},{"configs":{"itemId":"resetSearchBtn","glyph":"f0e2","tooltip":"@Str.resetSearch"},"expanded":false,"children":[],"type":"item","events":{"click":"app.loadDialog(app.currentUserData, true, '');"}},{"configs":{"itemId":"fillBtn","text":"->"},"expanded":false,"children":[],"type":"item"}],"type":"toolbar"},{"configs":{"itemId":"buttons"},"expanded":true,"children":[{"configs":{"itemId":"sendBtn","margin":"0 10 10 0","glyph":"f044","scale":"medium","text":"@Str.send"},"expanded":false,"children":[],"type":"button","events":{"click":"/* 应用服务器对每次通过WebSocket发送的文本大小有限制，比如使用Tomcat，在web.xml中可以通过如下配置增加大小：\n<context-param>\n\t<param-name>org.apache.tomcat.websocket.textBufferSize<\/param-name>\n\t<param-value>9000000<\/param-value>\n<\/context-param>\n*/\nvar msg = app.msgBox.getValue();\nif (msg.length > 5000) {\n  Wb.warn(str.exceedLimit);\n  return;\n}\napp.sendMessage(app.currentUserData, Wb.encodeHtml(msg));"}}],"type":"array"},{"configs":{"enterIsSpecial":"true","itemId":"msgBox","fieldStyle":"background:#f3f3f3;font-size:14px;","height":"100"},"expanded":false,"children":[],"type":"textarea","events":{"specialkey":"if (!app.acceptEnterbtn.pressed && e.getKey() == e.ENTER) {\n  e.stopEvent();\n  app.sendBtn.fireEvent('click');\n}","focus":"textarea.inputEl.setStyle('background', 'white');","blur":"textarea.inputEl.setStyle('background', '#f3f3f3');"}},{"configs":{"itemId":"form1","hidden":"true"},"expanded":true,"children":[{"configs":{"itemId":"file1"},"expanded":false,"children":[],"type":"file","events":{"change":"if (newValue) {\n  Wb.upload({\n    form: app.form1,\n    showProgress: true,\n    url: 'm?xwl=my/im/upload-file',\n    params: {\n      TO_USER: app.currentUserData.USER_ID\n    },\n    callback: function() {\n      Wb.reset(app.form1);\n    },\n    success: function(form, action, value) {\n      var obj = Wb.decode(value);\n      app.addDate(Wb.strToDate(obj.date), false);\n      app.sendMessage(app.currentUserData, obj.html, obj.id);\n    }\n  });\n}"}}],"type":"form"}],"type":"panel"}],"type":"viewport"}],"type":"module","events":{"finalize":"if (app.messageSocket.noWebSocket)\n  Wb.warn('您使用的终端不支持WebSocket。');","initialize":"var str = Wb.getLang({\n  sendFile: {\n    zh: '发送图片或文件',\n    en: 'Send picture or file'\n  },\n  acceptEnter: {\n    zh: '是否接收回车键的输入',\n    en: 'Whether accept Enter key'\n  },\n  exceedLimit: {\n    zh: '发送的文字数量最大允许5000，请使用文件发送。',\n    en: 'The maximum allow number of text sent is 5000, please send using file.'\n  },\n  me: {\n    zh: '我',\n    en: 'Me'\n  },\n  he: {\n    zh: '他',\n    en: 'He'\n  }\n});\nWb.apply(app, {\n  //系统重新连接广播的方法\n  xSessionReconnect: function() {\n    app.messageSocket.open();\n    //刷新当前用户的会话记录\n    if (app.currentUserData)\n      app.loadDialog(app.currentUserData, true);\n  },\n  //对话框中添加html\n  addRow: function(html, align, insertMode) {\n    var tr, td;\n    if (insertMode)\n      tr = app.dialogTable.insertRow(0);\n    else\n      tr = app.dialogTable.insertRow();\n    td = tr.insertCell();\n    if (align)\n      td.align = align;\n    td.innerHTML = html;\n  },\n  /**\n   * 向消息框添加单条消息。\n   * @param {String} msg 消息html内容。\n   * @param {Boolean} fromMe 是否由\u201c我\u201d发出。\n   * @param {Boolean} insertMode 插入模块，true插入到顶部，false在尾部添加。\n   * @param {String} msgId 消息id号。如果指定该参数，将在消息前加发送中的图标。\n   */\n  addMessage: function(msg, fromMe, insertMode, msgId) {\n    var sendingIcon, html = '<table cellpadding=\"5\"><tr>',\n      notUseBg = Ext.String.startsWith(msg, \"<img \");\n\n    app.notAddDate = false;\n    if (fromMe) {\n      sendingIcon = msgId ? '<td style=\"color:gray;display:none;\" class=\"wb_spiner\" id=\"' + msgId + '\">&#xf110;<\/td>' : '';\n      html += '<td width=\"50px\"><\/td>' + sendingIcon + '<td style=\"' + (notUseBg ? '' : 'background:#9de96a;') + 'border:1px solid #eee;\">' + msg + '<\/td>';\n      html += '<td style=\"color:#aaa;\">' + str.me + '<\/td>';\n      setTimeout(function() {\n        //超时显示发送中图标\n        var el = Ext.fly(msgId);\n        if (el)\n          el.setStyle('display', '');\n      }, Wb.maskTimeout);\n      setTimeout(function() {\n        //30秒后添加警告标记\n        var el = Ext.fly(msgId);\n        if (el) {\n          el.removeCls('wb_spiner');\n          el.addCls('wb_glyph');\n          el.update('&#xf071');\n          el.setStyle('color', '#d9534f');\n        }\n      }, 30000);\n    } else {\n      html += '<td style=\"color:#aaa;\">' + str.he + '<\/td>';\n      html += '<td style=\"' + (notUseBg ? '' : 'background:white;') + 'border:1px solid #eee;\">' + msg + '<\/td><td width=\"50px\"><\/td>';\n    }\n    html += '<\/tr><\/table>';\n    app.addRow(html, fromMe ? 'right' : 'left', insertMode);\n  },\n  //添加时间显示\n  addDate: function(date, insertMode, forceAdd) {\n    if (app.notAddDate || !date) return;\n    if (!app.lastAddDate)\n      app.lastAddDate = date;\n    if (forceAdd || Ext.Date.getElapsed(app.lastAddDate, date) > 600000) { //大于10分钟显示时间\n      app.addRow('<span style=\"color:white;font-size:12px;background:#ccc;padding:4px;\">' + Wb.dateToText(date) + '<\/span>', 'center', insertMode);\n      app.lastAddDate = date;\n      app.dateAdded = true;\n      app.notAddDate = true;\n    }\n  },\n  //设置消息已读\n  setRead: function(userId) {\n    var rec = app.hisUserStore.findExactRec('USER_ID', userId);\n    if (rec) {\n      Wb.request({\n        url: 'm?xwl=my/im/set-read',\n        params: {\n          FROM_USER: rec.data.USER_ID\n        },\n        success: function(resp) {\n          Wb.update(rec, {\n            NOT_READ: 0\n          });\n        }\n      });\n    }\n  },\n  //消息滚动条到最底部\n  toBottom: function() {\n    Wb.toBottom(app.dialogComp);\n  },\n  //加载同某个用户的对话记录\n  loadDialog: function(userData, forceLoad, searchText) {\n    var userId = userData.USER_ID;\n    if (!forceLoad && app.currentUserId == userId)\n      return;\n    if (app.msgPanel.disabled)\n      app.msgPanel.setDisabled(false);\n    var loadMessage = function(toBottom) {\n      if (app.msgLoading)\n        return;\n      app.msgLoading = true;\n      app.messageStore.load({\n        params: {\n          userId: userId,\n          searchText: searchText,\n          lastRecId: app.lastRecId\n        },\n        callback: function(records, o, success) {\n          app.msgLoading = false;\n          if (!success) return;\n          var scrollHeight = app.dialogComp.body.dom.scrollHeight;\n          app.setRead(userId);\n          Wb.each(records, function(rec) {\n            app.addMessage(rec.data.TEXT_CONTENT, rec.data.FROM_ME, true);\n            app.addDate(rec.data.SEND_DATE, true);\n          });\n          app.addDate(app.lastAddDate, true, !app.dateAdded);\n          app.dialogComp.body.dom.scrollTop = app.dialogComp.body.dom.scrollHeight - (toBottom ? 0 : scrollHeight);\n          app.currentUserId = userId;\n          app.currentUserData = userData;\n          app.lastRecId = records.length == 100 ? records[records.length - 1].data.IM_ID : null;\n        }\n      });\n    };\n    app.lastRecId = null;\n    app.lastAddDate = null;\n    app.dateAdded = false;\n    app.dialogComp.setTitle(Wb.format(\"{0} ({1})\", userData.DISPLAY_NAME, userData.USER_NAME));\n    app.onDialogScroll = null;\n    app.dialogComp.update(\"<table itemId='dialogTable' style='width:100%;line-height:1.5;font-size:14px;'><\/table>\");\n    app.dialogTable = app.dialogComp.el.down('[itemId=dialogTable]', true);\n    loadMessage(true);\n    app.onDialogScroll = loadMessage;\n  },\n  //添加用户到历史记录首条\n  addTopHisUser: function(userData) {\n    var userId = userData.USER_ID,\n      isSelected,\n      rec = app.hisUserStore.findExactRec('USER_ID', userId);\n    if (rec) {\n      if (app.hisUserStore.indexOf(rec) === 0) {\n        Wb.update(rec, userData);\n        return;\n      }\n      isSelected = app.hisUserView.selModel.isSelected(rec);\n      app.hisUserStore.remove(rec);\n    }\n    rec = app.hisUserStore.insert(0, userData)[0];\n    if (isSelected)\n      app.hisUserView.select(rec);\n  },\n  //向指定用户发送消息\n  sendMessage: function(userData, msg, existsRecId) {\n    if (!msg)\n      return;\n    var rec, toUser = userData.USER_ID,\n      msgId = Wb.getId(); //仅需客户端保持唯一\n    Wb.nullRequest(); //使保持会话\n    app.messageSocket.send({\n      TO_USER: toUser,\n      TEXT_CONTENT: msg,\n      msgId: msgId,\n      existsRecId: existsRecId\n    });\n    app.addMessage(msg, true, false, msgId);\n    //添加到历史记录\n    app.addTopHisUser(userData);\n    app.toBottom();\n    app.msgBox.reset();\n    app.msgBox.focus(false, true);\n  },\n  //禁止或允许对话框发送消息\n  disableDialog: function(disabled) {\n    var comps = [app.sendFileBtn, app.msgBox, app.sendBtn];\n    Wb.setDisabled(comps, disabled);\n  }\n});"}}],"roles":{},"title":"Str.im","iconCls":"comment_icon","inframe":false,"pageLink":""}