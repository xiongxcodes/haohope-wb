{"hidden":true,"children":[{"configs":{"itemId":"module","serverScript":"com.wb.interact.DBE.checkSelectSql(request, response);\napp.execute('m?xwl=dev/datainfo/SQL/dbm/utils');\nvar objects, jndi = app.get('jndi'),\n  sql = app.get('sql'),\n  defaultPrefix = app.getDefaultPrefix(app.getSqlTpl(DbUtil.getConnection(request, jndi)).tag.prefix, jndi) + '.';\nobjects = extractObjects(sql);\napp.loadObjectMap();\nWb.each(objects[1], function(item) {\n  if (!app.canAccess(item, 2)) {\n    SysUtil.accessDenied(request);\n  }\n});\nLogUtil.info(request, jndi + ':' + sql);\napp.output(sql + DbUtil.getOrderBySql(request, null), {\n  createColumns: true,\n  jndi: jndi,\n  dictTableNames: app.getBool('useDict') ? objects[0].join(',') : null\n});\n\n/**\n * 抽取对象名称。\n */\nfunction extractObjects(sql) {\n  var leftVal, items, pos, lowerSql, simpleName, fullName,\n    simpleResults = [],\n    fullResults = [],\n    endKeys = ['where', 'order', 'group'],\n    keys = ['by', 'as', 'all', 'and', 'on', 'or', 'not', 'distinct', 'select', 'update',\n      'delete', 'insert', 'truncate', 'drop', 'index', 'alter', 'left', 'outer', 'inner', 'full', 'join', 'corss', 'using',\n      'desc', 'asc', 'between', 'union', 'intersect', 'except', 'is', 'null', 'having'\n    ];\n  sql = StringUtil.replaceAll(sql, '\\n', ' ');\n  sql = StringUtil.replaceAll(sql, '\\t', ' ');\n  lowerSql = sql.toLowerCase();\n  pos = lowerSql.search(/\\bfrom\\b/);\n  if (pos != -1) {\n    sql = sql.substring(pos + 5);\n    lowerSql = lowerSql.substring(pos + 5);\n  }\n  Wb.each(endKeys, function(key) {\n    pos = lowerSql.search(new RegExp('\\\\b' + key + '\\\\b'));\n    if (pos != -1) {\n      lowerSql = lowerSql.substring(0, pos);\n      sql = sql.substring(0, pos);\n    }\n  });\n  Wb.each(keys, function(key) {\n    sql = replaceAll(sql, key, ',');\n  });\n  sql = StringUtil.replaceAll(sql, '`', '');\n  sql = StringUtil.replaceAll(sql, '\"', '');\n  items = sql.split(',');\n  Wb.each(items, function(item) {\n    item = item.trim();\n    if (!item)\n      return;\n    pos = item.indexOf(' ');\n    if (pos == -1)\n      leftVal = item.trim();\n    else\n      leftVal = item.substring(0, pos).trim();\n    if (verifyName(leftVal) === true) {\n      pos = leftVal.indexOf('.');\n      if (pos == -1) {\n        simpleName = leftVal;\n        fullName = jndi + '.' + defaultPrefix + leftVal;\n      } else {\n        simpleName = leftVal.substring(pos + 1);\n        fullName = jndi + '.' + leftVal;\n      }\n      simpleResults.push(simpleName);\n      fullResults.push(fullName);\n    }\n  });\n  return [simpleResults, fullResults];\n}\n\n//全字符串完整替换\nfunction replaceAll(string, source, dest) {\n  return string.replace(new RegExp('\\\\b' + source + '\\\\b', 'gi'), dest);\n}\n\n//验证名称合法性\nfunction verifyName(name) {\n  var c, i, j = name.length;\n  for (i = 0; i < j; i++) {\n    c = name.charAt(i);\n    if (!(c >= 'a' && c <= 'z' || c == '.' || c >= 'A' && c <= 'Z' || c == '_' || i > 0 && (c >= '0' && c <= '9')))\n      return Wb.format(Str.invalidChar, c);\n  }\n  return true;\n}"},"expanded":true,"children":[],"type":"module"}],"roles":{},"title":"执行SQL","iconCls":"","inframe":false,"pageLink":""}